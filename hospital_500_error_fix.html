<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hospital Details 500 Error Fix - HopeDrops</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-box {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .result {
        margin: 10px 0;
        padding: 15px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
      .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
      button {
        background: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
      input {
        width: 100px;
        padding: 8px;
        margin: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
    </style>
  </head>
  <body>
    <div class="test-box">
      <h2>üîß Hospital Details 500 Error Fix</h2>

      <div class="error">
        <strong>‚ùå ORIGINAL ERROR:</strong><br />
        <code
          >GET http://localhost/HopeDrops/php/get_hospital_details.php?user_id=6
          500 (Internal Server Error)</code
        ><br />
        <strong>Cause:</strong> Database query issues, missing columns, or PHP
        errors
      </div>

      <div class="success">
        <strong>‚úÖ FIX APPLIED:</strong><br />
        ‚Ä¢ Separated hospital and user queries for better error handling<br />
        ‚Ä¢ Added graceful handling for missing database columns<br />
        ‚Ä¢ Added safety checks for all field assignments<br />
        ‚Ä¢ Improved error handling and default values
      </div>

      <div>
        <label>Test with User ID: </label>
        <input type="number" id="userIdInput" value="6" placeholder="ID" />
        <button onclick="testAPI()">Test API Fix</button>
        <button onclick="testMultipleIds()">Test Multiple IDs</button>
      </div>

      <div id="results"></div>

      <div class="grid">
        <div class="test-box">
          <h3>üõ†Ô∏è Changes Made</h3>
          <pre>
1. Split Complex Query:
   Before: JOIN query that could fail
   After: Separate queries with error handling

2. Added Field Safety:
   Before: Direct assignment ($hospital['field'])
   After: Null coalescing ($hospital['field'] ?? 'default')

3. Column Existence Checks:
   Before: Assumed is_active exists
   After: Try-catch for optional columns

4. Better Error Messages:
   Before: Generic 500 error
   After: Detailed error info for debugging
                </pre
          >
        </div>

        <div class="test-box">
          <h3>üß™ Test Results</h3>
          <div id="testResults"></div>
        </div>
      </div>
    </div>

    <script>
      function addResult(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `result ${type}`;
        div.innerHTML = message;
        results.appendChild(div);
      }

      function addTestResult(message, type = "info") {
        const testResults = document.getElementById("testResults");
        const div = document.createElement("div");
        div.className = `result ${type}`;
        div.innerHTML = message;
        testResults.appendChild(div);
      }

      function testAPI() {
        const userId = document.getElementById("userIdInput").value;

        addResult(`üîÑ Testing fixed API with user_id=${userId}...`, "info");

        fetch(`../php/get_hospital_details.php?user_id=${userId}`)
          .then((response) => {
            if (response.status === 500) {
              addResult(
                "‚ùå Still getting 500 error - need further investigation",
                "error"
              );
              return response.text().then((text) => {
                addResult(`Response: ${text}`, "error");
                throw new Error("500 Internal Server Error");
              });
            } else if (response.status === 200) {
              addResult("‚úÖ 200 OK - API is working!", "success");
              return response.json();
            } else {
              addResult(`‚ö†Ô∏è HTTP Status: ${response.status}`, "warning");
              return response.json();
            }
          })
          .then((data) => {
            if (data.success) {
              addResult("‚úÖ Successful Response Received", "success");
              addResult(
                `<pre>${JSON.stringify(data, null, 2)}</pre>`,
                "success"
              );
              addTestResult("‚úÖ API working correctly", "success");
            } else {
              addResult(`‚ö†Ô∏è API Error: ${data.message}`, "warning");
              if (data.message.includes("Hospital not found")) {
                addResult(
                  "‚ÑπÔ∏è No hospital found for this user_id - try a different ID",
                  "info"
                );
              }
              addTestResult(`‚ö†Ô∏è ${data.message}`, "warning");
            }
          })
          .catch((error) => {
            addResult(`‚ùå Request Failed: ${error.message}`, "error");
            addTestResult(`‚ùå ${error.message}`, "error");
          });
      }

      function testMultipleIds() {
        addResult(
          "üîÑ Testing multiple user IDs to find working ones...",
          "info"
        );

        const testIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        let successCount = 0;
        let errorCount = 0;

        testIds.forEach((id) => {
          fetch(`../php/get_hospital_details.php?user_id=${id}`)
            .then((response) => {
              if (response.status === 200) {
                return response.json();
              } else {
                throw new Error(`HTTP ${response.status}`);
              }
            })
            .then((data) => {
              if (data.success) {
                addTestResult(
                  `‚úÖ ID ${id}: Found hospital "${data.data.hospital_name}"`,
                  "success"
                );
                successCount++;
              } else {
                addTestResult(`‚ö™ ID ${id}: ${data.message}`, "info");
              }
            })
            .catch((error) => {
              addTestResult(`‚ùå ID ${id}: ${error.message}`, "error");
              errorCount++;
            });
        });

        setTimeout(() => {
          if (successCount > 0) {
            addResult(
              `‚úÖ Found ${successCount} working hospital records`,
              "success"
            );
          } else if (errorCount > 0) {
            addResult(
              `‚ùå ${errorCount} errors encountered - API still has issues`,
              "error"
            );
          } else {
            addResult("‚ÑπÔ∏è No hospitals found in database yet", "info");
          }
        }, 2000);
      }

      // Test on load
      window.addEventListener("load", () => {
        addResult("üè• Testing Hospital Details API 500 Error Fix", "info");
        addResult(
          "üí° Original error: HTTP 500 when viewing hospital details",
          "info"
        );

        // Auto-test with user_id=6 (the one that was failing)
        setTimeout(() => {
          testAPI();
        }, 1000);
      });
    </script>
  </body>
</html>
