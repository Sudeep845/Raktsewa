<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Index Page Hospitals Test - HopeDrops</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-box {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .result {
        margin: 10px 0;
        padding: 15px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      button {
        background: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 10px;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="test-box">
      <h2>üè• Index Page Hospitals Loading Test</h2>

      <div class="info">
        <strong
          >Testing the fixed hospitals loading on the main index page</strong
        ><br />
        This should resolve the "TypeError: data.data.map is not a function"
        error.
      </div>

      <button onclick="testHospitalsAPI()">
        1. Test Hospitals API Response
      </button>
      <button onclick="testHospitalsDropdown()">
        2. Test Hospital Dropdown
      </button>
      <button onclick="testIndexPage()">3. Open Index Page</button>

      <div id="results"></div>

      <div
        style="
          margin-top: 20px;
          padding: 15px;
          border: 1px solid #ddd;
          border-radius: 4px;
        "
      >
        <h4>Hospital Selection Test:</h4>
        <select id="hospitalSelect">
          <option value="">Loading hospitals...</option>
        </select>
      </div>
    </div>

    <script>
      function addResult(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `result ${type}`;
        div.innerHTML = message;
        results.appendChild(div);
        div.scrollIntoView({ behavior: "smooth" });
      }

      async function testHospitalsAPI() {
        addResult("üîÑ Testing hospitals API response structure...", "info");

        try {
          const response = await fetch("php/get_hospitals.php", {
            credentials: "same-origin",
          });

          const data = await response.json();

          if (data.success) {
            const hasHospitalsProperty = data.data && data.data.hospitals;
            const isDirectArray = Array.isArray(data.data);
            const hospitalsArray = data.data.hospitals || data.data || [];

            addResult(
              `
                        <h4>‚úÖ API Response Analysis:</h4>
                        <p><strong>Response Structure:</strong> ${
                          hasHospitalsProperty
                            ? "Nested (data.data.hospitals)"
                            : "Direct (data.data)"
                        }</p>
                        <p><strong>Data Type:</strong> ${
                          isDirectArray
                            ? "Direct Array"
                            : "Object with hospitals property"
                        }</p>
                        <p><strong>Hospitals Count:</strong> ${
                          hospitalsArray.length
                        }</p>
                        <p><strong>Compatible:</strong> ${
                          Array.isArray(hospitalsArray) ? "Yes ‚úÖ" : "No ‚ùå"
                        }</p>
                        
                        <details>
                            <summary>View API Response Structure</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `,
              Array.isArray(hospitalsArray) ? "success" : "error"
            );
          } else {
            addResult(`‚ùå API Error: ${data.message}`, "error");
          }
        } catch (error) {
          addResult(`‚ùå API Request Failed: ${error.message}`, "error");
        }
      }

      async function testHospitalsDropdown() {
        addResult("üîÑ Testing hospital dropdown population...", "info");

        try {
          const response = await fetch("php/get_hospitals.php", {
            credentials: "same-origin",
          });
          const data = await response.json();

          const select = document.getElementById("hospitalSelect");

          if (data.success) {
            // Use the same logic as the fixed index.html
            const hospitals = data.data.hospitals || data.data || [];

            if (Array.isArray(hospitals)) {
              select.innerHTML =
                '<option value="">Select Hospital</option>' +
                hospitals
                  .map(
                    (hospital) =>
                      `<option value="${hospital.id}">${hospital.hospital_name} - ${hospital.city}</option>`
                  )
                  .join("");

              addResult(
                `
                            <h4>‚úÖ Dropdown Population Successful!</h4>
                            <p><strong>Options Created:</strong> ${
                              hospitals.length + 1
                            } (including "Select Hospital")</p>
                            <p><strong>Method:</strong> Using data.data.hospitals || data.data || []</p>
                            <p>Check the dropdown above to see the hospitals loaded.</p>
                        `,
                "success"
              );
            } else {
              addResult(
                `‚ùå Hospitals data is not an array: ${typeof hospitals}`,
                "error"
              );
            }
          } else {
            addResult(`‚ùå API Error: ${data.message}`, "error");
          }
        } catch (error) {
          addResult(`‚ùå Dropdown Test Failed: ${error.message}`, "error");
        }
      }

      function testIndexPage() {
        addResult("üîÑ Opening main index page...", "info");
        const indexWindow = window.open("index.html", "_blank");

        if (indexWindow) {
          addResult(
            `
                    ‚úÖ Index page opened in new tab<br>
                    <strong>Check for:</strong><br>
                    ‚Ä¢ No "TypeError: data.data.map is not a function" in console<br>
                    ‚Ä¢ Hospital dropdown in emergency form loads correctly<br>
                    ‚Ä¢ No JavaScript errors on page load<br>
                    <br>
                    <strong>To test:</strong> Scroll to the bottom emergency form and check if hospitals load.
                `,
            "success"
          );
        } else {
          addResult("‚ùå Failed to open index page - popup blocked?", "error");
        }
      }

      // Auto-test the dropdown on page load
      window.addEventListener("load", () => {
        setTimeout(() => {
          testHospitalsDropdown();
        }, 1000);
      });
    </script>
  </body>
</html>
