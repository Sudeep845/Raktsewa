<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - RaktaSewa Blood Bank</title>
    <meta
      name="description"
      content="Login to RaktaSewa Blood Bank Management System"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDMuMkMxMC4zIDMuMiA1LjcgNy44IDUuNyAxMy41QzUuNyAxOS4yIDEwLjMgMjMuOCAxNiAyMy44QzIxLjcgMjMuOCAyNi4zIDE5LjIgMjYuMyAxMy41QzI2LjMgNy44IDIxLjcgMy4yIDE2IDMuMloiIGZpbGw9IiNkYzM1NDUiLz4KPHBhdGggZD0iTTE2IDhWMTlIMTJWMTZIOVYxMkgxMlY4SDE2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- SweetAlert2 for beautiful alerts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <style>
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        background: linear-gradient(
          135deg,
          var(--primary-red-light),
          var(--accent-cream)
        );
      }

      .login-card {
        max-width: 450px;
        margin: 0 auto;
        box-shadow: var(--shadow-lg);
      }

      .login-header {
        background: linear-gradient(
          135deg,
          var(--primary-red),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        text-align: center;
        padding: 2rem;
      }

      .login-logo {
        width: 60px;
        height: 60px;
        margin: 0 auto 1rem;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .role-selector {
        display: flex;
        margin-bottom: 1.5rem;
        border-radius: var(--border-radius-sm);
        overflow: hidden;
        border: 1px solid var(--accent-border);
      }

      .role-option {
        flex: 1;
        padding: 0.75rem 1rem;
        background-color: var(--secondary-gray-light);
        border: none;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 0.9rem;
      }

      .role-option.active {
        background-color: var(--primary-red);
        color: var(--accent-white);
      }

      .role-option:hover:not(.active) {
        background-color: var(--accent-border);
      }

      .input-group {
        position: relative;
        margin-bottom: 1.5rem;
      }

      .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-gray);
        z-index: 1;
      }

      .form-control.with-icon {
        padding-left: 3rem;
      }

      .forgot-password {
        text-align: right;
        margin-bottom: 1.5rem;
      }

      .forgot-password a {
        color: var(--primary-red);
        font-size: 0.9rem;
        text-decoration: none;
      }

      .forgot-password a:hover {
        text-decoration: underline;
      }

      .login-footer {
        text-align: center;
        padding: 1rem;
        background-color: var(--secondary-gray-light);
        border-top: 1px solid var(--accent-border);
      }

      .back-to-home {
        position: absolute;
        top: 2rem;
        left: 2rem;
        color: var(--secondary-gray-dark);
        font-size: 1rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .back-to-home:hover {
        color: var(--primary-red);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-spinner {
        background-color: var(--accent-white);
        padding: 2rem;
        border-radius: var(--border-radius-md);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Back to Home Link -->
    <a href="index.html" class="back-to-home">
      <i class="fas fa-arrow-left"></i> Back to Home
    </a>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Logging in...</p>
      </div>
    </div>

    <div class="login-container">
      <div class="container">
        <div class="card login-card">
          <!-- Login Header -->
          <div class="login-header">
            <div class="login-logo">
              <i class="fas fa-tint"></i>
            </div>
            <h2>RaktaSewa Login</h2>
            <p>Access your account to save lives</p>
          </div>

          <!-- Login Form -->
          <div class="card-body" style="padding: 2rem">
            <!-- Role Selection -->
            <div class="role-selector">
              <button
                type="button"
                class="role-option active"
                data-role="donor"
              >
                <i class="fas fa-heart"></i> Donor
              </button>
              <button type="button" class="role-option" data-role="hospital">
                <i class="fas fa-hospital"></i> Hospital
              </button>
              <button type="button" class="role-option" data-role="admin">
                <i class="fas fa-user-shield"></i> Admin
              </button>
            </div>

            <form id="loginForm">
              <input
                type="hidden"
                id="selectedRole"
                name="role"
                value="donor"
              />

              <!-- Username/Email Input -->
              <div class="input-group">
                <div class="input-icon">
                  <i class="fas fa-user"></i>
                </div>
                <input
                  type="text"
                  id="username"
                  name="username"
                  class="form-control with-icon"
                  placeholder="Username or Email"
                  required
                  autocomplete="username"
                />
                <div class="invalid-feedback" id="usernameError"></div>
              </div>

              <!-- Password Input -->
              <div class="input-group">
                <div class="input-icon">
                  <i class="fas fa-lock"></i>
                </div>
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="form-control with-icon"
                  placeholder="Password"
                  required
                  autocomplete="current-password"
                />
                <button
                  type="button"
                  id="togglePassword"
                  style="
                    position: absolute;
                    right: 1rem;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: var(--secondary-gray);
                    cursor: pointer;
                  "
                >
                  <i class="fas fa-eye"></i>
                </button>
                <div class="invalid-feedback" id="passwordError"></div>
              </div>

              <!-- Remember Me & Forgot Password -->
              <div class="row" style="margin-bottom: 1.5rem">
                <div class="col-6">
                  <div class="form-check">
                    <input
                      type="checkbox"
                      id="rememberMe"
                      name="rememberMe"
                      class="form-check-input"
                    />
                    <label for="rememberMe" class="form-check-label"
                      >Remember me</label
                    >
                  </div>
                </div>
                <div class="col-6 text-right">
                  <a href="#" id="forgotPasswordLink">Forgot Password?</a>
                </div>
              </div>

              <!-- Login Button -->
              <button
                type="submit"
                class="btn btn-primary btn-lg"
                style="width: 100%"
                id="loginButton"
              >
                <i class="fas fa-sign-in-alt"></i> Login
              </button>
            </form>

            <!-- Alternative Login Methods -->
            <div style="margin: 1.5rem 0; text-align: center">
              <hr style="margin: 1rem 0" />
              <p style="color: var(--secondary-gray); margin: 0">or</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center">
              <button
                type="button"
                class="btn btn-secondary"
                id="guestLoginBtn"
              >
                <i class="fas fa-eye"></i> Guest Access
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="emergencyAccessBtn"
              >
                <i class="fas fa-exclamation-triangle"></i> Emergency Access
              </button>
            </div>
          </div>

          <!-- Login Footer -->
          <div class="login-footer">
            <p>
              Don't have an account? <a href="register.html">Create Account</a>
            </p>
            <p>
              <small
                >By logging in, you agree to our
                <a href="#">Terms of Service</a> and
                <a href="#">Privacy Policy</a></small
              >
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // Get URL parameters for pre-selecting role
      const urlParams = new URLSearchParams(window.location.search);
      const preselectedRole = urlParams.get("role");

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        if (
          preselectedRole &&
          ["admin", "hospital", "donor"].includes(preselectedRole)
        ) {
          selectRole(preselectedRole);
        }

        // Role selector functionality
        document.querySelectorAll(".role-option").forEach((button) => {
          button.addEventListener("click", function () {
            const role = this.dataset.role;
            selectRole(role);
          });
        });

        // Password toggle functionality
        document
          .getElementById("togglePassword")
          .addEventListener("click", function () {
            const passwordInput = document.getElementById("password");
            const icon = this.querySelector("i");

            if (passwordInput.type === "password") {
              passwordInput.type = "text";
              icon.classList.remove("fa-eye");
              icon.classList.add("fa-eye-slash");
            } else {
              passwordInput.type = "password";
              icon.classList.remove("fa-eye-slash");
              icon.classList.add("fa-eye");
            }
          });

        // Form submission
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);

        // Guest login
        document
          .getElementById("guestLoginBtn")
          .addEventListener("click", function () {
            window.location.href = "index.html#availability";
          });

        // Emergency access
        document
          .getElementById("emergencyAccessBtn")
          .addEventListener("click", function () {
            window.location.href = "index.html#emergency";
          });

        // Forgot password
        document
          .getElementById("forgotPasswordLink")
          .addEventListener("click", function (e) {
            e.preventDefault();
            showForgotPasswordModal();
          });
      });

      function selectRole(role) {
        // Update active state
        document.querySelectorAll(".role-option").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.querySelector(`[data-role="${role}"]`).classList.add("active");

        // Update hidden input
        document.getElementById("selectedRole").value = role;

        // Update placeholders based on role
        const usernameInput = document.getElementById("username");
        const placeholders = {
          admin: "Admin Username",
          hospital: "Hospital ID or Email",
          donor: "Email or Phone",
        };
        usernameInput.placeholder = placeholders[role] || "Username or Email";
      }

      function handleLogin(event) {
        event.preventDefault();

        // Clear previous errors
        clearErrors();

        // Get form data
        const formData = new FormData(event.target);
        const username = formData.get("username").trim();
        const password = formData.get("password");
        const role = formData.get("role");

        // Basic validation
        if (!username) {
          showFieldError("username", "Username/Email is required");
          return;
        }

        if (!password) {
          showFieldError("password", "Password is required");
          return;
        }

        if (password.length < 6) {
          showFieldError("password", "Password must be at least 6 characters");
          return;
        }

        // Show loading
        showLoading(true);
        disableForm(true);

        // Submit login request
        fetch("php/login.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            showLoading(false);
            disableForm(false);

            if (data.success) {
              // Set session data first to avoid timing issues
              if (typeof Session !== "undefined") {
                Session.setUser(data.data);
              }

              // Success - redirect to appropriate dashboard
              Swal.fire({
                icon: "success",
                title: "Login Successful!",
                text: `Welcome back, ${data.data.full_name}!`,
                timer: 1500,
                showConfirmButton: false,
              }).then(() => {
                // Wait a moment for session to be fully established
                setTimeout(() => {
                  // Redirect based on role
                  const redirectUrls = {
                    admin: "admin/dashboard.html",
                    hospital: "hospital/dashboard.html",
                    donor: "user/dashboard.html",
                  };
                  window.location.href =
                    redirectUrls[data.data.role] || "index.html";
                }, 100); // Small delay to ensure session is set
              });
            } else {
              // Error - show message
              Swal.fire({
                icon: "error",
                title: "Login Failed",
                text: data.message,
                confirmButtonColor: "#dc3545",
              });

              // Highlight specific field errors if provided
              if (data.field) {
                showFieldError(data.field, data.message);
              }
            }
          })
          .catch((error) => {
            console.error("Login error:", error);
            showLoading(false);
            disableForm(false);

            Swal.fire({
              icon: "error",
              title: "Connection Error",
              text: "Unable to connect to the server. Please try again.",
              confirmButtonColor: "#dc3545",
            });
          });
      }

      function showFieldError(fieldName, message) {
        const field = document.getElementById(fieldName);
        const errorDiv = document.getElementById(fieldName + "Error");

        if (field && errorDiv) {
          field.classList.add("is-invalid");
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
        }
      }

      function clearErrors() {
        document.querySelectorAll(".form-control").forEach((field) => {
          field.classList.remove("is-invalid");
        });
        document.querySelectorAll(".invalid-feedback").forEach((error) => {
          error.textContent = "";
          error.style.display = "none";
        });
      }

      function showLoading(show) {
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = show ? "flex" : "none";
      }

      function disableForm(disable) {
        const form = document.getElementById("loginForm");
        const inputs = form.querySelectorAll("input, button");
        inputs.forEach((input) => {
          input.disabled = disable;
        });

        const loginButton = document.getElementById("loginButton");
        if (disable) {
          loginButton.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        } else {
          loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        }
      }

      function showForgotPasswordModal() {
        Swal.fire({
          title: "Reset Password",
          html: `
                    <div class="form-group text-left" style="margin: 1rem 0;">
                        <label for="resetEmail" class="form-label">Enter your email address:</label>
                        <input type="email" id="resetEmail" class="form-control" placeholder="your-email@example.com" required>
                    </div>
                `,
          showCancelButton: true,
          confirmButtonText: "Send Reset Link",
          confirmButtonColor: "#dc3545",
          cancelButtonText: "Cancel",
          preConfirm: () => {
            const email = document.getElementById("resetEmail").value;
            if (!email) {
              Swal.showValidationMessage("Please enter your email address");
              return false;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
              Swal.showValidationMessage("Please enter a valid email address");
              return false;
            }
            return email;
          },
        }).then((result) => {
          if (result.isConfirmed) {
            // Here you would typically send a request to reset password
            Swal.fire({
              icon: "info",
              title: "Reset Link Sent",
              text: "If an account with that email exists, you will receive a password reset link shortly.",
              confirmButtonColor: "#dc3545",
            });
          }
        });
      }

      // Handle keyboard shortcuts
      document.addEventListener("keydown", function (event) {
        // Alt + 1,2,3 for quick role selection
        if (event.altKey) {
          switch (event.key) {
            case "1":
              event.preventDefault();
              selectRole("donor");
              break;
            case "2":
              event.preventDefault();
              selectRole("hospital");
              break;
            case "3":
              event.preventDefault();
              selectRole("admin");
              break;
          }
        }
      });

      // Check if user is already logged in
      fetch("php/check_session.php")
        .then((response) => response.json())
        .then((data) => {
          if (data.success && data.data.logged_in) {
            // User is already logged in, redirect to appropriate dashboard
            const role = data.data.role;
            const redirectUrls = {
              admin: "admin/dashboard.html",
              hospital: "hospital/dashboard.html",
              donor: "user/dashboard.html",
            };

            if (redirectUrls[role]) {
              Swal.fire({
                icon: "info",
                title: "Already Logged In",
                text: "Redirecting to your dashboard...",
                timer: 1500,
                showConfirmButton: false,
              }).then(() => {
                window.location.href = redirectUrls[role];
              });
            }
          }
        })
        .catch((error) => {
          console.log("Session check error (normal if not logged in):", error);
        });
    </script>
  </body>
</html>
