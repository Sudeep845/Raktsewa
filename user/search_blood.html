<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Find Blood Banks - RaktaSewa</title>
    <meta
      name="description"
      content="Search for nearby blood banks, hospitals, and donation centers"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDMuMkMxMC4zIDMuMiA1LjcgNy44IDUuNyAxMy41QzUuNyAxOS4yIDEwLjMgMjMuOCAxNiAyMy44QzIxLjcgMjMuOCAyNi4zIDE5LjIgMjYuMyAxMy41QzI2LjMgNy44IDIxLjcgMy4yIDE2IDMuMloiIGZpbGw9IiNkYzM1NDUiLz4KPHBhdGggZD0iTTE2IDhWMTlIMTJWMTZIOVYxMkgxMlY4SDE2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />

    <!-- SweetAlert2 for alerts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <style>
      /* Updated spacing v2.0 - Last updated: 2026-01-04 */
      .search-filters {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
      }

      .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
      }

      .search-results {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
      }

      .hospital-card {
        border-bottom: 1px solid var(--accent-border);
        padding: 1.5rem;
        transition: background-color var(--transition-fast);
      }

      .hospital-card:hover {
        background-color: rgba(220, 53, 69, 0.05);
      }

      .hospital-card:last-child {
        border-bottom: none;
      }

      /* --- Hospital Header Horizontal Alignment (copied from dashboard) --- */
      /* Only apply background to the main page header, not to each hospital card */
      .hospital-header {
        background: linear-gradient(
          135deg,
          var(--secondary-gray-dark),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-lg);
      }
      /* Remove background for .hospital-header inside .hospital-card */
      .hospital-card .hospital-header {
        background: none !important;
        color: inherit;
        padding: 0;
        box-shadow: none;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .hospital-nav {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .navbar-brand {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
      }
      .logo-icon {
        width: 40px;
        height: 40px;
        margin-right: 0.5rem;
        background: linear-gradient(
          135deg,
          var(--primary-red),
          var(--primary-red-dark)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
      }
      .hospital-user-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1.5rem;
        color: var(--accent-white);
      }
      .hospital-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent-white);
        color: var(--primary-red);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .hospital-info {
        flex: 1;
      }

      .hospital-name {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--primary-red);
        margin-bottom: 0.3rem;
        line-height: 1.3;
      }

      .hospital-type {
        color: var(--secondary-gray);
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        line-height: 1.4;
      }

      .hospital-address {
        color: var(--secondary-gray);
        font-size: 0.9rem;
        margin-bottom: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        line-height: 1.4;
      }

      .distance-badge {
        background: var(--info-blue);
        color: var(--accent-white);
        padding: 0.35rem 0.85rem;
        border-radius: var(--border-radius-lg);
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
      }

      .blood-availability {
        margin: 0.75rem 0;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
      }

      .blood-availability h6 {
        margin-bottom: 0.7rem;
        font-size: 1rem;
        font-weight: 600;
      }

      .blood-types-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.7rem;
        margin-top: 0.7rem;
      }

      .blood-type-card {
        text-align: center;
        padding: 0.7rem 0.5rem;
        border-radius: var(--border-radius-md);
        border: 2px solid;
        transition: all var(--transition-fast);
      }

      .blood-type-card.available {
        border-color: var(--success-green);
        background: rgba(56, 142, 60, 0.1);
        color: var(--success-green);
      }

      .blood-type-card.low {
        border-color: var(--warning-orange);
        background: rgba(245, 124, 0, 0.1);
        color: var(--warning-orange);
      }

      .blood-type-card.unavailable {
        border-color: var(--danger-red);
        background: rgba(211, 47, 47, 0.1);
        color: var(--danger-red);
      }

      .blood-type-label {
        font-weight: bold;
        font-size: 0.9rem;
      }

      .blood-units {
        font-size: 0.7rem;
        opacity: 0.8;
      }

      .hospital-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.9rem;
        padding-top: 0.9rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        flex-wrap: wrap;
      }

      .contact-info {
        display: flex;
        gap: 1.5rem;
        margin: 0.4rem 0 0.75rem 0;
        flex-wrap: wrap;
      }

      .contact-item {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        color: var(--secondary-gray);
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .contact-item i {
        font-size: 1rem;
        width: 20px;
        text-align: center;
      }

      .contact-item.text-muted {
        opacity: 0.6;
      }

      .emergency-banner {
        background: linear-gradient(135deg, var(--danger-red), #b71c1c);
        color: var(--accent-white);
        padding: 1rem;
        border-radius: var(--border-radius-md);
        margin-bottom: 2rem;
        text-align: center;
      }

      .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-gray);
      }

      .map-toggle {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
      }

      .map-container {
        height: 400px;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: var(--border-radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--secondary-gray);
        margin-bottom: 2rem;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-red);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .quick-filters {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .quick-filter {
        padding: 0.5rem 1rem;
        border: 2px solid var(--accent-border);
        border-radius: var(--border-radius-lg);
        background: var(--accent-white);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 0.9rem;
      }

      .quick-filter:hover,
      .quick-filter.active {
        border-color: var(--primary-red);
        background: var(--primary-red);
        color: var(--accent-white);
      }

      .blood-request-card {
        background: linear-gradient(
          135deg,
          var(--primary-red),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
      }

      @media (max-width: 768px) {
        .filter-row {
          grid-template-columns: 1fr;
        }

        /* Remove column override for .hospital-header to keep it horizontal */

        .contact-info {
          flex-direction: column;
          gap: 0.75rem;
        }

        .hospital-actions {
          flex-direction: column;
        }

        .map-toggle {
          bottom: 1rem;
          right: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="hospital-header">
      <div class="container">
        <nav class="hospital-nav">
          <div class="navbar-brand">
            <div class="logo-icon">
              <i class="fas fa-tint"></i>
            </div>
            <span style="color: #fff">RaktaSewa</span>
          </div>
          <div class="hospital-user-info">
            <div class="hospital-avatar" id="userAvatar">U</div>
            <div>
              <div style="font-weight: 500" id="userName">User</div>
              <div style="font-size: 0.8rem; opacity: 0.8" id="userBloodType">
                Blood Donor
              </div>
            </div>
            <button
              class="btn btn-secondary btn-sm"
              type="button"
              onclick="logout()"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </nav>
      </div>
    </header>

    <div class="dashboard">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <!-- Sidebar header removed for cleaner sidebar -->
        <nav class="sidebar-nav">
          <ul>
            <li class="sidebar-nav-item">
              <a href="dashboard.html" class="sidebar-nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="search_blood.html" class="sidebar-nav-link active">
                <i class="fas fa-search"></i> Find Blood Banks
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="history.html" class="sidebar-nav-link">
                <i class="fas fa-history"></i> Donation History
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="rewards.html" class="sidebar-nav-link">
                <i class="fas fa-trophy"></i> Rewards & Badges
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a
                href="#"
                onclick="showAppointmentModal()"
                class="sidebar-nav-link"
              >
                <i class="fas fa-calendar-check"></i> Appointments
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a
                href="#"
                onclick="showCampaignsModal()"
                class="sidebar-nav-link"
              >
                <i class="fas fa-bullhorn"></i> Campaigns
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Header -->
        <div class="page-header">
          <h1><i class="fas fa-search"></i> Find Blood Banks</h1>
          <p>Locate nearby blood banks, hospitals, and donation centers</p>
        </div>

        <!-- Emergency Banner -->
        <div
          class="emergency-banner"
          id="emergencyBanner"
          style="display: none"
        >
          <h4>
            <i class="fas fa-exclamation-triangle"></i> Emergency Blood Request
          </h4>
          <p>
            Need blood urgently? Contact these hospitals directly for immediate
            assistance.
          </p>
          <button
            class="btn btn-light btn-sm"
            onclick="showEmergencyContacts()"
          >
            <i class="fas fa-phone"></i> Emergency Contacts
          </button>
        </div>

        <!-- Blood Request Card -->
        <div class="blood-request-card">
          <h4><i class="fas fa-heart"></i> Need Blood?</h4>
          <p>
            Find blood banks and hospitals near you. Check availability in
            real-time and contact directly for urgent needs.
          </p>
          <button class="btn btn-light" onclick="toggleEmergencyMode()">
            <i class="fas fa-exclamation-triangle"></i> Emergency Mode
          </button>
        </div>

        <!-- Search Filters -->
        <div class="search-filters">
          <form id="searchForm">
            <div class="filter-row">
              <div class="form-group">
                <label for="location">Location</label>
                <div class="input-group">
                  <input
                    type="text"
                    id="location"
                    class="form-control"
                    placeholder="Enter city or area"
                    value=""
                  />
                  <div class="input-group-append">
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      onclick="getCurrentLocation()"
                    >
                      <i class="fas fa-crosshairs"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="bloodType">Blood Type</label>
                <select id="bloodType" class="form-control">
                  <option value="">All Blood Types</option>
                  <option value="O-">O-</option>
                  <option value="O+">O+</option>
                  <option value="A-">A-</option>
                  <option value="A+">A+</option>
                  <option value="B-">B-</option>
                  <option value="B+">B+</option>
                  <option value="AB-">AB-</option>
                  <option value="AB+">AB+</option>
                </select>
              </div>

              <div class="form-group">
                <label for="radius">Search Radius</label>
                <select id="radius" class="form-control">
                  <option value="5">5 km</option>
                  <option value="10" selected>10 km</option>
                  <option value="25">25 km</option>
                  <option value="50">50 km</option>
                </select>
              </div>

              <div class="form-group">
                <label for="hospitalType">Facility Type</label>
                <select id="hospitalType" class="form-control">
                  <option value="">All Facilities</option>
                  <option value="hospital">Hospitals</option>
                  <option value="blood_bank">Blood Banks</option>
                  <option value="clinic">Clinics</option>
                  <option value="donation_center">Donation Centers</option>
                </select>
              </div>

              <div class="form-group">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search"></i> Search
                </button>
              </div>
            </div>

            <div class="quick-filters">
              <div class="quick-filter" onclick="quickFilter('emergency')">
                <i class="fas fa-ambulance"></i> 24/7 Emergency
              </div>
              <div class="quick-filter" onclick="quickFilter('nearby')">
                <i class="fas fa-map-marker-alt"></i> Nearby (5km)
              </div>
              <div class="quick-filter" onclick="quickFilter('available')">
                <i class="fas fa-check-circle"></i> Blood Available
              </div>
              <div class="quick-filter" onclick="quickFilter('donation')">
                <i class="fas fa-tint"></i> Accepting Donations
              </div>
            </div>
          </form>
        </div>

        <!-- Map Container -->
        <div class="map-container" id="mapContainer" style="display: none">
          <div>
            <i class="fas fa-map fa-3x mb-3"></i>
            <p>Map integration coming soon!</p>
            <p>
              Interactive map with hospital locations and directions will be
              available here.
            </p>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
          <div class="spinner"></div>
          <p>Searching for blood banks...</p>
        </div>

        <!-- Search Results -->
        <div class="search-results" id="searchResults">
          <!-- Results will be populated here -->
        </div>
      </main>
    </div>

    <!-- Map Toggle Button -->
    <button class="btn btn-primary btn-lg map-toggle" onclick="toggleMap()">
      <i class="fas fa-map" id="mapToggleIcon"></i>
    </button>

    <!-- Emergency Contacts Modal -->
    <div class="modal fade" id="emergencyModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-phone"></i> Emergency Blood Contacts
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="emergencyContacts">
            <!-- Emergency contacts will be loaded here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hospital Details Modal -->
    <div class="modal fade" id="hospitalModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="hospitalModalTitle">
              Hospital Details
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="hospitalDetails">
            <!-- Hospital details will be loaded here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="contactHospital(currentHospitalId)"
            >
              <i class="fas fa-phone"></i> Contact Hospital
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts will be loaded at the end of body -->

    <script>
      // Global logout function for header button
      function logout() {
        if (
          typeof Notifications !== "undefined" &&
          typeof Session !== "undefined"
        ) {
          Notifications.confirm(
            "Logout",
            "Are you sure you want to logout?"
          ).then((result) => {
            if (result.isConfirmed) {
              Session.logout()
                .then(() => {
                  window.location.href = "../index.html";
                })
                .catch(() => {
                  window.location.href = "../index.html";
                });
            }
          });
        } else {
          // Fallback: just redirect
          window.location.href = "../index.html";
        }
      }
      let currentLocation = null;
      let searchResults = [];
      let isEmergencyMode = false;
      let mapVisible = false;
      let authChecked = false; // Prevent multiple auth checks
      let autoRefreshInterval = null; // Auto-refresh timer
      let emergencyHospitals = []; // Store emergency hospitals data
      let currentHospitalId = null; // Store current hospital ID for modal actions

      // Helper function to escape HTML
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Prevent multiple checks
        if (authChecked) return;
        authChecked = true;

        console.log("[SEARCH_BLOOD] Page loading, checking authentication...");

        // Check immediately if dependencies are already loaded
        if (
          typeof Session !== "undefined" &&
          typeof API !== "undefined" &&
          typeof Notifications !== "undefined"
        ) {
          console.log(
            "[SEARCH_BLOOD] Dependencies already loaded, initializing immediately..."
          );
          initializePage();
          return;
        }

        // If not loaded yet, wait with a short interval
        console.log("[SEARCH_BLOOD] Waiting for dependencies to load...");
        let checkCount = 0;
        const checkDependencies = setInterval(() => {
          checkCount++;
          if (
            typeof Session !== "undefined" &&
            typeof API !== "undefined" &&
            typeof Notifications !== "undefined"
          ) {
            clearInterval(checkDependencies);
            console.log(
              `[SEARCH_BLOOD] Dependencies loaded after ${checkCount * 10}ms`
            );
            initializePage();
          } else if (checkCount > 500) {
            // 5 seconds max
            clearInterval(checkDependencies);
            console.error("[SEARCH_BLOOD] Dependencies failed to load");
            alert(
              "System Error: Required components not loaded. Please refresh the page."
            );
          }
        }, 10); // Check every 10ms for faster response
      });

      function initializePage() {
        // Check user authentication first, then proceed
        checkUserAuth()
          .then((user) => {
            // Set dynamic user info in header
            setUserHeaderInfo(user);
            console.log("[SEARCH_BLOOD] Auth passed, loading page content...");
            // Load initial data
            performInitialSearch();

            // Load emergency alerts
            loadEmergencyAlerts();

            // Set up form submission
            document
              .getElementById("searchForm")
              .addEventListener("submit", handleSearch);

            // Set up auto-refresh every 60 seconds
            autoRefreshInterval = setInterval(() => {
              console.log("[SEARCH_BLOOD] Auto-refreshing search results...");
              searchBloodBanks();
              loadEmergencyAlerts();
            }, 60000);
          })
          .catch(() => {
            console.log("[SEARCH_BLOOD] Auth failed, should redirect...");
            // Auth failed, will redirect
          });
      }

      function setUserHeaderInfo(user) {
        if (!user) return;
        // Set avatar (first letter of full_name or username or U)
        const avatar = document.getElementById("userAvatar");
        if (avatar)
          avatar.textContent =
            user.full_name && user.full_name.length > 0
              ? user.full_name.charAt(0).toUpperCase()
              : user.username
              ? user.username.charAt(0).toUpperCase()
              : "U";
        // Set username (full_name or username)
        const userName = document.getElementById("userName");
        if (userName)
          userName.textContent =
            user.full_name && user.full_name.length > 0
              ? user.full_name
              : user.username || "";
        // Set blood type or role
        const userBloodType = document.getElementById("userBloodType");
        if (userBloodType)
          userBloodType.textContent = user.blood_type
            ? `${user.blood_type} Donor`
            : user.role
            ? user.role.charAt(0).toUpperCase() + user.role.slice(1)
            : "Blood Donor";
      }

      function checkUserAuth() {
        console.log("[SEARCH_BLOOD] Starting authentication check...");

        // Check if Session object is available
        if (typeof Session === "undefined") {
          console.error(
            "[SEARCH_BLOOD] Session object not available - main.js not loaded?"
          );
          alert(
            "System Error: Session management not loaded. Please refresh the page."
          );
          return Promise.reject(new Error("Session object missing"));
        }

        // Prevent redirect loops
        const urlParams = new URLSearchParams(window.location.search);
        const fromLogin = urlParams.get("from") === "login";

        if (fromLogin) {
          console.log(
            "[SEARCH_BLOOD] Recently came from login, skipping redirect check"
          );
        }

        return Session.checkSession()
          .then((user) => {
            console.log("[SEARCH_BLOOD] Session check result:", user);

            if (!user) {
              console.log("[SEARCH_BLOOD] No user session found");
              if (!fromLogin) {
                console.log("[SEARCH_BLOOD] Redirecting to login...");
                window.location.replace("../login.html?role=donor");
              }
              return Promise.reject(new Error("No session"));
            }

            if (user.role !== "donor") {
              console.log(
                "[SEARCH_BLOOD] Wrong role - expected 'donor', got:",
                user.role
              );
              if (!fromLogin) {
                console.log("[SEARCH_BLOOD] Redirecting due to wrong role...");
                window.location.replace("../login.html?role=donor");
              }
              return Promise.reject(new Error("Wrong role"));
            }

            console.log("[SEARCH_BLOOD] âœ… Auth SUCCESS - role:", user.role);
            return Promise.resolve(user);
          })
          .catch((error) => {
            console.error("[SEARCH_BLOOD] Auth check failed:", error);
            if (
              !fromLogin &&
              !error.message.includes("Session object missing")
            ) {
              console.log(
                "[SEARCH_BLOOD] Redirecting to login due to error..."
              );
              window.location.replace("../login.html?role=donor");
            }
            return Promise.reject(error);
          });
      }

      function performInitialSearch() {
        // Load all hospitals on initial page load
        showLoading(true);

        API.get("get_hospitals.php", { limit: 50 })
          .then((response) => {
            if (response.success && response.data && response.data.hospitals) {
              searchResults = response.data.hospitals;
              console.log(
                "[SEARCH_BLOOD] Initial load:",
                searchResults.length,
                "hospitals"
              );
              displaySearchResults(searchResults);
            } else {
              // Fallback to regular search
              searchBloodBanks();
            }
          })
          .catch((error) => {
            console.error("Initial load error:", error);
            // Fallback to regular search
            searchBloodBanks();
          })
          .finally(() => {
            showLoading(false);
          });
      }

      function handleSearch(e) {
        e.preventDefault();
        searchBloodBanks();
      }

      function searchBloodBanks() {
        const searchData = {
          location: document.getElementById("location").value,
          blood_type: document.getElementById("bloodType").value,
          radius: document.getElementById("radius").value,
          hospital_type: document.getElementById("hospitalType").value,
          emergency_mode: isEmergencyMode,
        };

        showLoading(true);

        API.post("search_hospitals.php", searchData)
          .then((response) => {
            if (response.success) {
              // Extract hospitals array from the response data
              searchResults = response.data.hospitals || [];
              console.log("[SEARCH_BLOOD] Search results:", searchResults);
              displaySearchResults(searchResults);

              // Log search info for debugging
              if (response.data.search_info) {
                console.log(
                  "[SEARCH_BLOOD] Search info:",
                  response.data.search_info
                );
              }
            } else {
              throw new Error(response.message);
            }
          })
          .catch((error) => {
            console.error("Search error:", error);
            displayNoResults();
            Notifications.error(
              "Search Error",
              "Failed to search blood banks: " + error.message
            );
          })
          .finally(() => {
            showLoading(false);
          });
      }

      function displaySearchResults(results) {
        const container = document.getElementById("searchResults");

        console.log("[SEARCH_BLOOD] Displaying results:", results);

        // Ensure results is an array
        if (!Array.isArray(results)) {
          console.error(
            "[SEARCH_BLOOD] Results is not an array:",
            typeof results,
            results
          );
          displayNoResults();
          return;
        }

        if (results.length === 0) {
          displayNoResults();
          return;
        }

        try {
          container.innerHTML = results
            .map((hospital) => createHospitalCard(hospital))
            .join("");
          container.style.display = "block";

          console.log(
            "[SEARCH_BLOOD] Successfully displayed",
            results.length,
            "hospitals"
          );
        } catch (error) {
          console.error("[SEARCH_BLOOD] Error displaying results:", error);
          displayNoResults();
        }
      }

      function createHospitalCard(hospital) {
        // Log hospital data for debugging
        console.log("[SEARCH_BLOOD] Creating card for hospital:", hospital);
        console.log("[SEARCH_BLOOD] Hospital fields check:", {
          contact_phone: hospital.contact_phone,
          phone: hospital.phone,
          contact_email: hospital.contact_email,
          email: hospital.email,
        });

        // Ensure hospital object has required properties with defaults
        // Handle multiple possible field names from API
        // IMPORTANT: Spread hospital first, then override with our computed values
        const safeHospital = {
          ...hospital,
          id: hospital.id || 0,
          hospital_name: hospital.hospital_name || "Unknown Hospital",
          hospital_type: hospital.hospital_type || "General",
          address: hospital.address || "Address not available",
          city: hospital.city || "",
          state: hospital.state || "",
          phone:
            hospital.contact_phone ||
            hospital.phone ||
            hospital.contact_number ||
            hospital.phone_number ||
            "",
          email:
            hospital.contact_email ||
            hospital.email ||
            hospital.email_address ||
            "",
          emergency_contact: hospital.emergency_contact || null,
          blood_inventory: hospital.blood_inventory || [],
          total_units: hospital.total_units || 0,
          website: hospital.website || "",
        };

        console.log("[SEARCH_BLOOD] SafeHospital phone:", safeHospital.phone);
        console.log("[SEARCH_BLOOD] SafeHospital email:", safeHospital.email);

        return `
                <div class="hospital-card" data-hospital-id="${
                  safeHospital.id
                }">
                    <div class="hospital-header">
                        <div class="hospital-info">
                            <div class="hospital-name">${escapeHtml(
                              safeHospital.hospital_name
                            )}</div>
                            <div class="hospital-type">
                                <i class="fas fa-${getHospitalIcon(
                                  safeHospital.hospital_type
                                )}"></i>
                                <span>${escapeHtml(
                                  safeHospital.hospital_type
                                )}</span>
                                ${
                                  safeHospital.is_24_7
                                    ? '<span class="badge badge-success ml-2">24/7</span>'
                                    : ""
                                }
                            </div>
                            <div class="hospital-address">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${escapeHtml(
                                  safeHospital.address
                                )}, ${escapeHtml(safeHospital.city)}</span>
                            </div>
                        </div>
                        ${
                          safeHospital.distance
                            ? `<div class="distance-badge">${safeHospital.distance} km</div>`
                            : ""
                        }
                    </div>
                    
                    <div class="contact-info">
                        ${
                          safeHospital.phone &&
                          safeHospital.phone !== "Not available"
                            ? `
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <span>${escapeHtml(safeHospital.phone)}</span>
                        </div>
                        `
                            : `
                        <div class="contact-item text-muted">
                            <i class="fas fa-phone"></i>
                            <span>Phone not available</span>
                        </div>
                        `
                        }
                        ${
                          safeHospital.email &&
                          safeHospital.email !== "N/A" &&
                          safeHospital.email !== "Not available"
                            ? `
                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <span>${escapeHtml(safeHospital.email)}</span>
                        </div>
                        `
                            : `
                        <div class="contact-item text-muted">
                            <i class="fas fa-envelope"></i>
                            <span>Email not available</span>
                        </div>
                        `
                        }
                        ${
                          safeHospital.website
                            ? `
                        <div class="contact-item">
                            <i class="fas fa-globe"></i>
                            <a href="${escapeHtml(
                              safeHospital.website
                            )}" target="_blank">Website</a>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    
                    <div class="blood-availability">
                        <h6><i class="fas fa-tint"></i> Blood Availability</h6>
                        <div class="blood-types-grid">
                            ${createBloodTypeCards(
                              safeHospital.blood_inventory || []
                            )}
                        </div>
                    </div>
                    
                    <div class="hospital-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewHospitalDetails(${
                          safeHospital.id
                        })">
                            <i class="fas fa-info-circle"></i> View Details
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="contactHospital(${
                          safeHospital.id
                        })">
                            <i class="fas fa-phone"></i> Contact
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="getDirections('${
                          safeHospital.address
                        }, ${safeHospital.city}')">
                            <i class="fas fa-directions"></i> Directions
                        </button>
                        ${
                          safeHospital.accepts_donations
                            ? `
                        <button class="btn btn-outline-info btn-sm" onclick="scheduleAppointment(${safeHospital.id})">
                            <i class="fas fa-calendar-plus"></i> Schedule Donation
                        </button>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;
      }

      function createBloodTypeCards(inventory) {
        const bloodTypes = ["O-", "O+", "A-", "A+", "B-", "B+", "AB-", "AB+"];

        return bloodTypes
          .map((type) => {
            const item = inventory.find((inv) => inv.blood_type === type);
            // Check for units_available (API format) or units (fallback)
            const units = item ? item.units_available || item.units || 0 : 0;

            let statusClass = "unavailable";
            if (units > 10) statusClass = "available";
            else if (units > 0) statusClass = "low";

            return `
                    <div class="blood-type-card ${statusClass}">
                        <div class="blood-type-label">${type}</div>
                        <div class="blood-units">${units} units</div>
                    </div>
                `;
          })
          .join("");
      }

      function getHospitalIcon(type) {
        const icons = {
          hospital: "hospital",
          blood_bank: "tint",
          clinic: "clinic-medical",
          donation_center: "hand-holding-heart",
        };
        return icons[type] || "hospital";
      }

      function displayNoResults() {
        const container = document.getElementById("searchResults");
        container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                    <h4>No blood banks found</h4>
                    <p>Try adjusting your search criteria or expanding the search radius.</p>
                    <button class="btn btn-primary" onclick="expandSearch()">
                        <i class="fas fa-expand"></i> Expand Search
                    </button>
                </div>
            `;
      }

      function showLoading(show) {
        document.getElementById("loadingSpinner").style.display = show
          ? "block"
          : "none";
        document.getElementById("searchResults").style.display = show
          ? "none"
          : "block";
      }

      function quickFilter(type) {
        // Remove active class from all filters
        document.querySelectorAll(".quick-filter").forEach((filter) => {
          filter.classList.remove("active");
        });

        // Add active class to clicked filter
        event.target.classList.add("active");

        switch (type) {
          case "emergency":
            document.getElementById("hospitalType").value = "hospital";
            isEmergencyMode = true;
            break;
          case "nearby":
            document.getElementById("radius").value = "5";
            getCurrentLocation();
            break;
          case "available":
            // Filter for hospitals with blood availability
            break;
          case "donation":
            // Filter for hospitals accepting donations
            break;
        }

        searchBloodBanks();
      }

      function getCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;

              // Reverse geocode to get address
              // For demo, we'll just show coordinates
              document.getElementById("location").value = `${lat.toFixed(
                4
              )}, ${lng.toFixed(4)}`;
              currentLocation = { lat, lng };

              searchBloodBanks();
            },
            (error) => {
              console.error("Geolocation error:", error);
              Notifications.error(
                "Location Error",
                "Unable to get your current location. Please enter location manually."
              );
            }
          );
        } else {
          Notifications.error(
            "Location Error",
            "Geolocation is not supported by this browser."
          );
        }
      }

      function toggleEmergencyMode() {
        isEmergencyMode = !isEmergencyMode;

        const banner = document.getElementById("emergencyBanner");
        if (isEmergencyMode) {
          banner.style.display = "block";
          document.getElementById("hospitalType").value = "hospital";
        } else {
          banner.style.display = "none";
        }

        searchBloodBanks();
      }

      function toggleMap() {
        const mapContainer = document.getElementById("mapContainer");
        const mapToggleIcon = document.getElementById("mapToggleIcon");

        mapVisible = !mapVisible;

        if (mapVisible) {
          mapContainer.style.display = "block";
          mapToggleIcon.className = "fas fa-list";
        } else {
          mapContainer.style.display = "none";
          mapToggleIcon.className = "fas fa-map";
        }
      }

      function viewHospitalDetails(hospitalId) {
        const hospital = searchResults.find((h) => h.id == hospitalId);
        if (!hospital) return;

        // Store current hospital ID for modal actions
        currentHospitalId = hospitalId;

        // Get phone and email with same logic as card display
        const phone =
          hospital.contact_phone || hospital.phone || "Not available";
        const email =
          hospital.contact_email || hospital.email || "Not available";

        const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> Hospital Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${escapeHtml(
                              hospital.hospital_name
                            )}</td></tr>
                            <tr><td><strong>Type:</strong></td><td>${escapeHtml(
                              hospital.hospital_type || "Hospital"
                            )}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${escapeHtml(
                              phone
                            )}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${escapeHtml(
                              email
                            )}</td></tr>
                            <tr><td><strong>Website:</strong></td><td>${
                              hospital.website
                                ? `<a href="${escapeHtml(
                                    hospital.website
                                  )}" target="_blank">Visit Website</a>`
                                : "N/A"
                            }</td></tr>
                            <tr><td><strong>24/7 Service:</strong></td><td>${
                              hospital.is_24_7 ? "Yes" : "No"
                            }</td></tr>
                            <tr><td><strong>Accepts Donations:</strong></td><td>${
                              hospital.accepts_donations ? "Yes" : "No"
                            }</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt"></i> Location</h6>
                        <p>${escapeHtml(hospital.address)}<br>
                           ${escapeHtml(hospital.city)}, ${escapeHtml(
          hospital.state || ""
        )}<br>
                           ${escapeHtml(hospital.postal_code || "")}</p>
                        
                        <h6><i class="fas fa-clock"></i> Operating Hours</h6>
                        <p>${
                          hospital.operating_hours ||
                          "Contact hospital for hours"
                        }</p>
                        
                        <h6><i class="fas fa-tint"></i> Blood Services</h6>
                        <ul class="list-unstyled">
                            ${
                              hospital.services
                                ? hospital.services
                                    .split(",")
                                    .map(
                                      (service) =>
                                        `<li><i class="fas fa-check text-success"></i> ${escapeHtml(
                                          service.trim()
                                        )}</li>`
                                    )
                                    .join("")
                                : "<li>Contact hospital for services</li>"
                            }
                        </ul>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-tint"></i> Current Blood Inventory</h6>
                        <div class="blood-types-grid">
                            ${createBloodTypeCards(
                              hospital.blood_inventory || []
                            )}
                        </div>
                    </div>
                </div>
            `;

        document.getElementById("hospitalModalTitle").textContent =
          hospital.hospital_name;
        document.getElementById("hospitalDetails").innerHTML = content;
        $("#hospitalModal").modal("show");
      }

      function contactHospital(hospitalId) {
        // Look for hospital in search results or emergency hospitals
        const hospital = hospitalId
          ? searchResults.find((h) => h.id == hospitalId) ||
            emergencyHospitals.find((h) => h.id == hospitalId)
          : null;

        if (hospital) {
          const phone =
            hospital.phone || hospital.contact_phone || "Not available";
          const emergencyPhone = hospital.emergency_contact;
          const email =
            hospital.email || hospital.contact_email || "Not available";
          const contactPerson = hospital.contact_person;

          const contactContent = `
            <div class="contact-hospital-details">
              <div class="mb-3">
                <h6 class="text-primary"><i class="fas fa-hospital mr-2"></i>${escapeHtml(
                  hospital.hospital_name
                )}</h6>
                <p class="text-muted mb-0">${escapeHtml(
                  hospital.address
                )}, ${escapeHtml(hospital.city)}${
            hospital.state ? ", " + escapeHtml(hospital.state) : ""
          }</p>
              </div>
              
              <div class="card mb-3">
                <div class="card-body">
                  <h6><i class="fas fa-phone text-success mr-2"></i>Phone Numbers</h6>
                  <table class="table table-sm table-borderless mb-0">
                    <tr>
                      <td><strong>Main:</strong></td>
                      <td>
                        <a href="tel:${phone}" class="text-primary">${escapeHtml(
            phone
          )}</a>
                        <button class="btn btn-success btn-sm ml-2" onclick="window.open('tel:${phone}')">
                          <i class="fas fa-phone"></i> Call
                        </button>
                      </td>
                    </tr>
                    ${
                      emergencyPhone
                        ? `
                    <tr>
                      <td><strong>Emergency:</strong></td>
                      <td>
                        <a href="tel:${emergencyPhone}" class="text-danger">${escapeHtml(
                            emergencyPhone
                          )}</a>
                        <button class="btn btn-danger btn-sm ml-2" onclick="window.open('tel:${emergencyPhone}')">
                          <i class="fas fa-phone"></i> Call
                        </button>
                      </td>
                    </tr>
                    `
                        : ""
                    }
                  </table>
                </div>
              </div>
              
              <div class="card mb-3">
                <div class="card-body">
                  <h6><i class="fas fa-envelope text-info mr-2"></i>Email</h6>
                  <p class="mb-2">
                    ${
                      email !== "Not available"
                        ? `
                      <a href="mailto:${email}" class="text-primary">${escapeHtml(
                            email
                          )}</a>
                    `
                        : '<span class="text-muted">Not available</span>'
                    }
                  </p>
                  ${
                    email !== "Not available"
                      ? `
                  <button class="btn btn-info btn-sm" onclick="window.open('mailto:${email}')">
                    <i class="fas fa-envelope"></i> Send Email
                  </button>
                  `
                      : ""
                  }
                </div>
              </div>
              
              ${
                contactPerson
                  ? `
              <div class="card mb-3">
                <div class="card-body">
                  <h6><i class="fas fa-user text-warning mr-2"></i>Contact Person</h6>
                  <p class="mb-0">${escapeHtml(contactPerson)}</p>
                </div>
              </div>
              `
                  : ""
              }
              
              <div class="card">
                <div class="card-body">
                  <h6><i class="fas fa-directions text-secondary mr-2"></i>Get Directions</h6>
                  <button class="btn btn-secondary btn-block" onclick="getDirections('${escapeHtml(
                    hospital.address
                  )}, ${escapeHtml(hospital.city)}')">
                    <i class="fas fa-map-marked-alt"></i> Open in Google Maps
                  </button>
                </div>
              </div>
              
              <div class="alert alert-info mt-3 mb-0">
                <small>
                  <i class="fas fa-info-circle mr-1"></i>
                  For blood donation inquiries, please call during business hours.
                  For emergencies, use the emergency contact number.
                </small>
              </div>
            </div>
          `;

          Swal.fire({
            title: "Contact Information",
            html: contactContent,
            width: "600px",
            showCloseButton: true,
            showConfirmButton: false,
            customClass: {
              container: "contact-hospital-modal",
            },
          });
        } else {
          Notifications.error(
            "Error",
            "Hospital contact information not found."
          );
        }
      }

      function getDirections(address) {
        // Open Google Maps with directions
        const encodedAddress = encodeURIComponent(address);
        const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
        window.open(mapsUrl, "_blank");
      }

      function scheduleAppointment(hospitalId) {
        Notifications.info(
          "Schedule Appointment",
          "Appointment scheduling feature coming soon!"
        );
      }

      function showEmergencyContacts() {
        // Show loading state
        document.getElementById("emergencyContacts").innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-danger mb-3"></i>
            <p>Loading emergency contacts...</p>
          </div>
        `;
        $("#emergencyModal").modal("show");

        // Fetch emergency hospitals from API
        API.get("get_hospitals.php", { emergency_only: true, limit: 50 })
          .then((response) => {
            if (response.success && response.data && response.data.hospitals) {
              displayEmergencyContacts(response.data.hospitals);
            } else {
              // Fallback to search results
              const emergencyHospitals = searchResults.filter(
                (h) => h.emergency_contact || h.phone
              );
              displayEmergencyContacts(emergencyHospitals);
            }
          })
          .catch((error) => {
            console.error("Failed to load emergency contacts:", error);
            // Fallback to search results
            const emergencyHospitals = searchResults.filter(
              (h) => h.emergency_contact || h.phone
            );
            displayEmergencyContacts(emergencyHospitals);
          });
      }

      function displayEmergencyContacts(hospitals) {
        // Store hospitals for later use
        emergencyHospitals = hospitals;

        const content =
          hospitals.length > 0
            ? hospitals
                .map((hospital) => {
                  const primaryPhone =
                    hospital.emergency_contact ||
                    hospital.phone ||
                    hospital.contact_phone;
                  const bloodInventory = hospital.blood_inventory || [];
                  const totalUnits = bloodInventory.reduce(
                    (sum, inv) => sum + (inv.units_available || 0),
                    0
                  );

                  return `
                <div class="emergency-contact-item border border-danger p-3 mb-3 rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h6 class="text-danger mb-1">
                          <i class="fas fa-hospital-alt mr-2"></i>${escapeHtml(
                            hospital.hospital_name
                          )}
                        </h6>
                        <small class="text-muted">
                          <i class="fas fa-building mr-1"></i>${
                            hospital.hospital_type || "General Hospital"
                          }
                        </small>
                      </div>
                      ${
                        totalUnits > 0
                          ? `<span class="badge badge-success">${totalUnits} units available</span>`
                          : ""
                      }
                    </div>
                    
                    <div class="mb-2">
                      <p class="mb-1">
                        <i class="fas fa-phone text-danger mr-2"></i>
                        <strong>${escapeHtml(primaryPhone)}</strong>
                        ${
                          hospital.emergency_contact
                            ? '<span class="badge badge-danger ml-2">Emergency Line</span>'
                            : ""
                        }
                      </p>
                      <p class="mb-1 small text-muted">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        ${escapeHtml(hospital.address)}, ${escapeHtml(
                    hospital.city
                  )}${hospital.state ? ", " + escapeHtml(hospital.state) : ""}
                      </p>
                    </div>

                    ${
                      bloodInventory.length > 0
                        ? `
                    <div class="mb-2">
                      <small class="text-muted d-block mb-1">Available Blood Types:</small>
                      <div class="d-flex flex-wrap gap-1">
                        ${bloodInventory
                          .filter((inv) => inv.units_available > 0)
                          .map(
                            (inv) => `
                            <span class="badge badge-${
                              inv.units_available > 10
                                ? "success"
                                : inv.units_available > 5
                                ? "warning"
                                : "secondary"
                            } mr-1">
                              ${inv.blood_type}: ${inv.units_available}
                            </span>
                          `
                          )
                          .join("")}
                      </div>
                    </div>
                    `
                        : ""
                    }
                    
                    <div class="d-flex gap-2">
                      <button class="btn btn-danger btn-sm mr-2" onclick="window.open('tel:${primaryPhone}')">
                          <i class="fas fa-phone"></i> Call Now
                      </button>
                      <button class="btn btn-outline-danger btn-sm" onclick="viewHospitalDetailsFromEmergency(${
                        hospital.id
                      });">
                          <i class="fas fa-info-circle"></i> Details
                      </button>
                    </div>
                </div>
            `;
                })
                .join("")
            : `
              <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                <h5>No emergency contacts available</h5>
                <p class="text-muted">Please contact your local emergency services at <strong>911</strong></p>
                <p class="text-muted">or search for nearby hospitals above.</p>
              </div>
            `;

        document.getElementById("emergencyContacts").innerHTML = content;
      }

      function expandSearch() {
        document.getElementById("radius").value = "50";
        document.getElementById("bloodType").value = "";
        document.getElementById("hospitalType").value = "";
        searchBloodBanks();
      }

      function viewHospitalDetailsFromEmergency(hospitalId) {
        // Close emergency modal first
        $("#emergencyModal").modal("hide");

        // Look for hospital in emergency hospitals array first, then search results
        const hospital =
          emergencyHospitals.find((h) => h.id == hospitalId) ||
          searchResults.find((h) => h.id == hospitalId);

        if (!hospital) {
          Notifications.error("Error", "Hospital details not found");
          return;
        }

        // Store current hospital ID for modal actions
        currentHospitalId = hospitalId;

        const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> Hospital Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${escapeHtml(
                              hospital.hospital_name
                            )}</td></tr>
                            <tr><td><strong>Type:</strong></td><td>${escapeHtml(
                              hospital.hospital_type || "Hospital"
                            )}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${escapeHtml(
                              hospital.phone || hospital.contact_phone
                            )}</td></tr>
                            <tr><td><strong>Emergency:</strong></td><td>${escapeHtml(
                              hospital.emergency_contact || "N/A"
                            )}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${escapeHtml(
                              hospital.email || hospital.contact_email || "N/A"
                            )}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt"></i> Location</h6>
                        <p>${escapeHtml(hospital.address)}<br>
                           ${escapeHtml(hospital.city)}${
          hospital.state ? ", " + escapeHtml(hospital.state) : ""
        }</p>
                        
                        <div class="mt-3">
                          <a href="tel:${
                            hospital.emergency_contact || hospital.phone
                          }" class="btn btn-danger btn-block">
                            <i class="fas fa-phone"></i> Call Emergency Line
                          </a>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-tint"></i> Current Blood Inventory</h6>
                        <div class="blood-types-grid">
                            ${createBloodTypeCards(
                              hospital.blood_inventory || []
                            )}
                        </div>
                    </div>
                </div>
            `;

        document.getElementById("hospitalModalTitle").textContent =
          hospital.hospital_name;
        document.getElementById("hospitalDetails").innerHTML = content;
        $("#hospitalModal").modal("show");
      }

      // Modal functions
      function showAppointmentModal() {
        // Redirect to dedicated appointments page
        window.location.href = "appointments.html";
      }

      function showCampaignsModal() {
        window.location.href = "campaigns.html";
      }

      // Load emergency alerts function
      function loadEmergencyAlerts() {
        API.get("get_donor_dashboard_data.php")
          .then((response) => {
            if (response.success && response.emergency_requests) {
              displayEmergencyAlertsBanner(response.emergency_requests);
            }
          })
          .catch((error) => {
            console.error(
              "[SEARCH_BLOOD] Failed to load emergency alerts:",
              error
            );
          });
      }

      function displayEmergencyAlertsBanner(requests) {
        const criticalRequests = requests.filter(
          (r) =>
            r.urgency_level === "critical" || r.urgency_level === "emergency"
        );

        if (criticalRequests.length === 0) return;

        // Add emergency banner if not already present
        const existingBanner = document.querySelector(
          ".emergency-alerts-banner"
        );
        if (existingBanner) existingBanner.remove();

        const banner = document.createElement("div");
        banner.className = "emergency-alerts-banner";
        banner.innerHTML = `
          <div class="alert alert-danger mb-3" style="animation: pulse 2s ease-in-out infinite;">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <i class="fas fa-exclamation-triangle fa-lg mr-2"></i>
                <strong>${criticalRequests.length} Emergency Blood Request(s)</strong>
                <span class="ml-2">Urgent attention needed!</span>
              </div>
              <button class="btn btn-light btn-sm" onclick="viewEmergencyDetails()">
                View Details
              </button>
            </div>
          </div>
        `;

        const searchFilters = document.querySelector(".search-filters");
        if (searchFilters) {
          searchFilters.parentNode.insertBefore(banner, searchFilters);
        }
      }

      function viewEmergencyDetails() {
        API.get("get_donor_dashboard_data.php").then((response) => {
          if (response.success && response.emergency_requests) {
            showEmergencyModal(response.emergency_requests);
          }
        });
      }

      function showEmergencyModal(requests) {
        const criticalRequests = requests.filter(
          (r) =>
            r.urgency_level === "critical" ||
            r.urgency_level === "emergency" ||
            r.urgency_level === "high"
        );

        const content = `
          <div class="emergency-requests-list">
            ${criticalRequests
              .map(
                (req) => `
              <div class="card mb-3 border-danger">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5 class="text-danger mb-2">
                        <i class="fas fa-tint mr-2"></i>${
                          req.blood_type
                        } Blood Needed
                      </h5>
                      <p class="mb-1"><strong>${
                        req.hospital_name || "Hospital"
                      }</strong></p>
                      <p class="mb-1">${req.location || req.city || ""}</p>
                      <p class="mb-1">Units needed: <strong>${
                        req.units_needed
                      }</strong></p>
                      <p class="mb-0 text-muted">${
                        req.notes || req.description || ""
                      }</p>
                    </div>
                    <span class="badge badge-danger">${req.urgency_level.toUpperCase()}</span>
                  </div>
                  <div class="mt-3">
                    <a href="tel:${
                      req.phone || req.hospital_phone
                    }" class="btn btn-danger btn-sm mr-2">
                      <i class="fas fa-phone"></i> Call ${
                        req.phone || req.hospital_phone
                      }
                    </a>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;

        Swal.fire({
          title: "Emergency Blood Requests",
          html: content,
          width: "600px",
          showCloseButton: true,
          showConfirmButton: false,
        });
      }

      // Cleanup interval on page unload
      window.addEventListener("beforeunload", () => {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
      });
    </script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Main Application JS -->
    <script src="../js/main.js"></script>
  </body>
</html>
