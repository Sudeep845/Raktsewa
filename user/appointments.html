<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Appointments - RaktaSewa</title>
    <meta
      name="description"
      content="View and manage your blood donation appointments"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDMuMkMxMC4zIDMuMiA1LjcgNy44IDUuNyAxMy41QzUuNyAxOS4yIDEwLjMgMjMuOCAxNiAyMy44QzIxLjcgMjMuOCAyNi4zIDE5LjIgMjYuMyAxMy41QzI2LjMgNy44IDIxLjcgMy4yIDE2IDMuMloiIGZpbGw9IiNkYzM1NDUiLz4KPHBhdGggZD0iTTE2IDhWMTlIMTJWMTZIOVYxMkgxMlY4SDE2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />

    <!-- SweetAlert2 for alerts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <style>
      .navbar-brand {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
      }
      .hospital-header {
        background: linear-gradient(
          135deg,
          var(--secondary-gray-dark),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-lg);
      }
      .hospital-nav {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .hospital-user-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1.5rem;
        color: var(--accent-white);
      }
      .hospital-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent-white);
        color: var(--primary-red);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .appointments-header {
        background: linear-gradient(
          135deg,
          var(--primary-red),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
      }

      .stat-card {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        text-align: center;
        transition: transform var(--transition-fast);
        border-left: 4px solid;
      }

      .stat-card:hover {
        transform: translateY(-3px);
      }

      .stat-card.primary {
        border-left-color: var(--primary-red);
      }

      .stat-card.success {
        border-left-color: var(--success-green);
      }

      .stat-card.warning {
        border-left-color: var(--warning-orange);
      }

      .stat-card.info {
        border-left-color: var(--info-blue);
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .appointment-card {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        transition: transform var(--transition-fast);
      }

      .appointment-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .appointment-card.scheduled {
        border-left: 4px solid var(--primary-red);
      }

      .appointment-card.confirmed {
        border-left: 4px solid var(--info-blue);
      }

      .appointment-card.completed {
        border-left: 4px solid var(--success-green);
      }

      .appointment-card.cancelled {
        border-left: 4px solid var(--danger-red);
      }

      .appointment-card.rescheduled {
        border-left: 4px solid var(--warning-orange);
      }

      .filter-tabs {
        background: var(--accent-white);
        padding: 1rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
      }

      .filter-btn {
        padding: 0.5rem 1.5rem;
        border: 2px solid transparent;
        background: transparent;
        border-radius: var(--border-radius-md);
        margin-right: 0.5rem;
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .filter-btn:hover {
        background: rgba(220, 53, 69, 0.1);
      }

      .filter-btn.active {
        background: var(--primary-red);
        color: var(--accent-white);
      }

      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-gray);
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
    </style>
  </head>

  <body>
    <!-- User Header (Hospital Style) -->
    <header class="hospital-header">
      <div class="container">
        <nav class="hospital-nav">
          <div class="navbar-brand">
            <div class="logo-icon">
              <i class="fas fa-tint"></i>
            </div>
            <span style="color: #fff">RaktaSewa</span>
          </div>
          <div class="hospital-user-info">
            <div class="hospital-avatar" id="userAvatar">U</div>
            <div>
              <div style="font-weight: 500" id="userName">User</div>
              <div style="font-size: 0.8rem; opacity: 0.8" id="userBloodType">
                Blood Donor
              </div>
            </div>
            <button
              class="btn btn-secondary btn-sm"
              type="button"
              onclick="logout()"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </nav>
      </div>
    </header>

    <div class="dashboard">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul>
            <li class="sidebar-nav-item">
              <a href="dashboard.html" class="sidebar-nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="search_blood.html" class="sidebar-nav-link">
                <i class="fas fa-search"></i> Find Blood Banks
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="history.html" class="sidebar-nav-link">
                <i class="fas fa-history"></i> Donation History
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="rewards.html" class="sidebar-nav-link">
                <i class="fas fa-trophy"></i> Rewards & Badges
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="appointments.html" class="sidebar-nav-link active">
                <i class="fas fa-calendar-check"></i> Appointments
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a
                href="#"
                onclick="showCampaignsModal()"
                class="sidebar-nav-link"
              >
                <i class="fas fa-bullhorn"></i> Campaigns
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Page Header -->
        <div class="appointments-header">
          <div class="container-fluid">
            <h2><i class="fas fa-calendar-check mr-2"></i> My Appointments</h2>
            <p class="mb-0">View and manage your blood donation appointments</p>
          </div>
        </div>

        <div class="container-fluid">
          <!-- Statistics Cards -->
          <div class="row mb-4" id="statsContainer">
            <div class="col-md-3">
              <div class="stat-card primary">
                <div class="stat-number primary" id="upcomingCount">0</div>
                <div class="stat-label">Upcoming</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card success">
                <div class="stat-number success" id="completedCount">0</div>
                <div class="stat-label">Completed</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card warning">
                <div class="stat-number warning" id="cancelledCount">0</div>
                <div class="stat-label">Cancelled</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card info">
                <div class="stat-number info" id="totalCount">0</div>
                <div class="stat-label">Total</div>
              </div>
            </div>
          </div>

          <!-- User Header (Hospital Style) -->

          <!-- Loading Spinner -->
          <div
            id="loadingSpinner"
            class="loading-spinner"
            style="display: none"
          >
            <div class="spinner-border text-danger" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>

          <!-- Appointments List -->
          <div id="appointmentsContainer" style="display: none"></div>

          <!-- Empty State -->
          <div class="empty-state" id="emptyState" style="display: none">
            <i class="fas fa-calendar-times"></i>
            <h4>No Appointments Found</h4>
            <p>You haven't scheduled any blood donation appointments yet.</p>
            <a href="search_blood.html" class="btn btn-primary mt-3">
              <i class="fas fa-search"></i> Find Blood Banks
            </a>
          </div>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/main.js"></script>

    <script>
      let allAppointments = [];
      let currentFilter = "all";

      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        loadUserInfo();
        loadAppointments();
      });

      function loadUserInfo() {
        if (typeof Session !== "undefined" && Session.isLoggedIn()) {
          const user = Session.getCurrentUser();
          if (user) {
            // Set avatar (first letter of full_name or username or U)
            const avatar = document.getElementById("userAvatar");
            if (avatar)
              avatar.textContent =
                user.full_name && user.full_name.length > 0
                  ? user.full_name.charAt(0).toUpperCase()
                  : user.username
                  ? user.username.charAt(0).toUpperCase()
                  : "U";
            // Set username (full_name or username)
            const userName = document.getElementById("userName");
            if (userName)
              userName.textContent =
                user.full_name && user.full_name.length > 0
                  ? user.full_name
                  : user.username || "";
            // Set blood type or role
            const userBloodType = document.getElementById("userBloodType");
            if (userBloodType)
              userBloodType.textContent = user.blood_type
                ? `${user.blood_type} Donor`
                : user.role
                ? user.role.charAt(0).toUpperCase() + user.role.slice(1)
                : "Blood Donor";
          }
        }
      }

      function checkAuth() {
        if (typeof Session === "undefined") {
          console.warn("Session object not found. Running in test mode.");
          return; // Allow access for testing
        }

        Session.checkSession()
          .then((user) => {
            if (!user || user.role !== "donor") {
              console.warn(
                "User not logged in as donor. Running in test mode."
              );
              // Don't redirect in test mode, just warn
            }
          })
          .catch((error) => {
            console.warn("Auth check failed. Running in test mode:", error);
            // Don't redirect in test mode, just warn
          });
      }

      function loadAppointments() {
        document.getElementById("loadingSpinner").style.display = "flex";
        document.getElementById("appointmentsContainer").style.display = "none";
        document.getElementById("emptyState").style.display = "none";

        // Get donor ID from session or use fallback for testing
        let donorId = null;
        if (typeof Session !== "undefined" && Session.isLoggedIn()) {
          const user = Session.getCurrentUser();
          console.log("Appointments - Current user object:", user);

          // Try user_id (returned by check_session.php)
          if (user && user.user_id) {
            donorId = user.user_id;
            console.log("Using logged-in user ID:", donorId);
          }
        }

        // If no session, use fallback donor ID (same as dashboard.html)
        if (!donorId) {
          donorId = 3; // Fallback donor ID for testing
          console.warn("Using fallback donor ID:", donorId);
        }

        // Add donor_id parameter to API call
        API.get("get_appointments.php?donor_id=" + donorId)
          .then((response) => {
            if (response.success && response.data) {
              allAppointments = response.data.appointments || [];
              updateStats(response.data.stats || {});
              displayAppointments();
            } else {
              throw new Error(
                response.message || "Failed to load appointments"
              );
            }
          })
          .catch((error) => {
            console.error("Failed to load appointments:", error);
            Notifications.error("Error", error.message);
            showEmptyState();
          })
          .finally(() => {
            document.getElementById("loadingSpinner").style.display = "none";
          });
      }

      function updateStats(stats) {
        document.getElementById("upcomingCount").textContent =
          stats.upcoming || 0;
        document.getElementById("completedCount").textContent =
          stats.completed || 0;
        document.getElementById("cancelledCount").textContent =
          stats.cancelled || 0;
        document.getElementById("totalCount").textContent = stats.total || 0;
      }

      function filterAppointments(filter) {
        currentFilter = filter;

        // Update active button
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        displayAppointments();
      }

      function displayAppointments() {
        let filtered = allAppointments;

        if (currentFilter === "upcoming") {
          filtered = allAppointments.filter(
            (apt) => apt.status === "scheduled" || apt.status === "confirmed"
          );
        } else if (currentFilter === "completed") {
          filtered = allAppointments.filter(
            (apt) => apt.status === "completed"
          );
        } else if (currentFilter === "cancelled") {
          filtered = allAppointments.filter(
            (apt) => apt.status === "cancelled"
          );
        }

        if (filtered.length === 0) {
          showEmptyState();
          return;
        }

        const container = document.getElementById("appointmentsContainer");
        container.style.display = "block";
        document.getElementById("emptyState").style.display = "none";

        container.innerHTML = filtered
          .map(
            (apt) => `
            <div class="appointment-card ${apt.status}">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="mb-2">
                    <i class="fas fa-hospital text-${getStatusColor(
                      apt.status
                    )} mr-2"></i>
                    ${escapeHtml(apt.hospital_name || "Hospital")}
                  </h5>
                  <p class="mb-1">
                    <i class="fas fa-calendar text-muted mr-2"></i>
                    <strong>${formatDate(apt.appointment_date)}</strong> at 
                    <strong>${formatTime(apt.appointment_time)}</strong>
                  </p>
                  <p class="mb-1">
                    <i class="fas fa-tint text-danger mr-2"></i>
                    Blood Type: <strong>${apt.blood_type}</strong>
                  </p>
                  ${
                    apt.notes
                      ? `
                  <p class="mb-0 text-muted small">
                    <i class="fas fa-sticky-note mr-2"></i>
                    ${escapeHtml(apt.notes)}
                  </p>
                  `
                      : ""
                  }
                </div>
                <div class="col-md-4 text-right">
                  <span class="badge badge-${getStatusColor(
                    apt.status
                  )} badge-lg mb-3">
                    ${apt.status.toUpperCase()}
                  </span>
                  <div>
                    ${
                      apt.status === "scheduled" || apt.status === "confirmed"
                        ? `
                    <button class="btn btn-outline-danger btn-sm" onclick="cancelAppointment(${apt.id})">
                      <i class="fas fa-times"></i> Cancel
                    </button>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            </div>
          `
          )
          .join("");
      }

      function showEmptyState() {
        document.getElementById("appointmentsContainer").style.display = "none";
        document.getElementById("emptyState").style.display = "block";
      }

      function cancelAppointment(appointmentId) {
        Swal.fire({
          title: "Cancel Appointment?",
          text: "Are you sure you want to cancel this appointment?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#dc3545",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Yes, cancel it",
          cancelButtonText: "No, keep it",
        }).then((result) => {
          if (result.isConfirmed) {
            API.post("cancel_appointment.php", {
              appointment_id: appointmentId,
            })
              .then((response) => {
                if (response.success) {
                  Notifications.success(
                    "Cancelled",
                    "Appointment cancelled successfully"
                  );
                  loadAppointments();
                } else {
                  throw new Error(response.message);
                }
              })
              .catch((error) => {
                Notifications.error(
                  "Error",
                  "Failed to cancel appointment: " + error.message
                );
              });
          }
        });
      }

      function getStatusColor(status) {
        const colors = {
          scheduled: "primary",
          confirmed: "info",
          completed: "success",
          cancelled: "danger",
          rescheduled: "warning",
        };
        return colors[status] || "secondary";
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function formatTime(timeString) {
        if (!timeString) return "";
        const [hours, minutes] = timeString.split(":");
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? "PM" : "AM";
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showProfileModal() {
        Notifications.info("Profile", "Profile editing feature coming soon!");
      }

      function showCampaignsModal() {
        window.location.href = "campaigns.html";
      }

      function logout() {
        Session.logout().then(() => {
          window.location.href = "../login.html";
        });
      }
    </script>
  </body>
</html>
