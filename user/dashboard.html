<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard - RaktaSewa</title>
    <meta
      name="description"
      content="RaktaSewa User Dashboard - Blood Donation Tracking and Rewards"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDMuMkMxMC4zIDMuMiA1LjcgNy44IDUuNyAxMy41QzUuNyAxOS4yIDEwLjMgMjMuOCAxNiAyMy44QzIxLjcgMjMuOCAyNi4zIDE5LjIgMjYuMyAxMy41QzI2LjMgNy44IDIxLjcgMy4yIDE2IDMuMloiIGZpbGw9IiNkYzM1NDUiLz4KPHBhdGggZD0iTTE2IDhWMTlIMTJWMTZIOVYxMkgxMlY4SDE2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- SweetAlert2 for alerts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      .user-header {
        background: linear-gradient(
          135deg,
          var(--success-green),
          var(--primary-red)
        );
        color: var(--accent-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-md);
      }

      .user-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .hospital-header {
        background: linear-gradient(
          135deg,
          var(--secondary-gray-dark),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-lg);
      }
      .hospital-nav {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .hospital-user-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1.5rem;
        color: var(--accent-white);
      }
      .hospital-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent-white);
        color: var(--primary-red);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .stat-card-user.success {
        border-left: 4px solid var(--success-green);
      }

      .stat-card-user.warning {
        border-left: 4px solid var(--warning-orange);
      }

      .stat-card-user.info {
        border-left: 4px solid var(--info-blue);
      }

      .stat-number-large {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .stat-number-large.primary {
        color: var(--primary-red);
      }
      .stat-number-large.success {
        color: var(--success-green);
      }
      .stat-number-large.warning {
        color: var(--warning-orange);
      }
      .stat-number-large.info {
        color: var(--info-blue);
      }

      .next-donation-card {
        background: linear-gradient(
          135deg,
          var(--primary-red),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        text-align: center;
      }

      .countdown-timer {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 1rem 0;
      }

      .countdown-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.75rem;
        border-radius: var(--border-radius-md);
        min-width: 60px;
      }

      .countdown-number {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
      }

      .countdown-label {
        font-size: 0.8rem;
        opacity: 0.9;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .action-card {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 2px solid transparent;
        text-decoration: none;
        color: inherit;
      }

      .action-card:hover {
        transform: translateY(-3px);
        border-color: var(--primary-red);
        text-decoration: none;
        color: inherit;
      }

      .action-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
      }

      .action-icon.search {
        background: #e3f2fd;
        color: #1976d2;
      }
      .action-icon.history {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .action-icon.rewards {
        background: #fff3e0;
        color: #f57c00;
      }
      .action-icon.schedule {
        background: #e8f5e8;
        color: #388e3c;
      }

      .blood-compatibility-card {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .compatibility-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .compatibility-item {
        padding: 1rem;
        border: 2px solid var(--accent-border);
        border-radius: var(--border-radius-md);
        text-align: center;
      }

      .compatibility-item.can-donate {
        border-color: var(--success-green);
        background: rgba(56, 142, 60, 0.1);
      }

      .compatibility-item.can-receive {
        border-color: var(--info-blue);
        background: rgba(25, 118, 210, 0.1);
      }

      .blood-types-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 0.5rem;
      }

      .blood-type-tag {
        background: var(--primary-red);
        color: var(--accent-white);
        padding: 0.25rem 0.75rem;
        border-radius: var(--border-radius-lg);
        font-size: 0.8rem;
        font-weight: bold;
      }

      .rewards-summary {
        background: linear-gradient(135deg, var(--warning-orange), #ff8f00);
        color: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
      }

      .rewards-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .rewards-points {
        font-size: 2rem;
        font-weight: bold;
      }

      .upcoming-campaigns {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
      }

      .campaign-item {
        padding: 1rem;
        border-bottom: 1px solid var(--accent-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .campaign-item:last-child {
        border-bottom: none;
      }

      .campaign-info {
        flex: 1;
      }

      .campaign-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .campaign-meta {
        font-size: 0.8rem;
        color: var(--secondary-gray);
      }

      .recent-activity {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
      }

      .activity-item {
        padding: 1rem;
        border-bottom: 1px solid var(--accent-border);
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }

      .activity-icon.donation {
        background: #ffebee;
        color: #d32f2f;
      }
      .activity-icon.appointment {
        background: #e3f2fd;
        color: #1976d2;
      }
      .activity-icon.reward {
        background: #fff3e0;
        color: #f57c00;
      }

      .eligibility-status {
        padding: 1rem;
        border-radius: var(--border-radius-md);
        margin-bottom: 2rem;
        text-align: center;
      }

      .eligibility-status.eligible {
        background: var(--success-green);
        color: var(--accent-white);
      }

      .eligibility-status.ineligible {
        background: var(--danger-red);
        color: var(--accent-white);
      }

      .eligibility-status.pending {
        background: var(--warning-orange);
        color: var(--accent-white);
      }

      /* Emergency Alerts Styling */
      .emergency-alerts-section {
        margin-bottom: 2rem;
        animation: slideDown 0.5s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .blink-text {
        animation: blink 1.5s infinite;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .emergency-request-card {
        border-left: 4px solid var(--danger-red);
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fff5f5;
        border-radius: var(--border-radius-md);
        transition: all 0.3s ease;
      }

      .emergency-request-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateX(5px);
      }

      .urgency-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: bold;
      }

      .urgency-critical {
        background: #d32f2f;
        color: white;
        animation: pulse 1s infinite;
      }

      .urgency-emergency {
        background: #f44336;
        color: white;
      }

      .urgency-high {
        background: #ff9800;
        color: white;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* Nearby Hospitals Styling */
      .hospital-card {
        border: 1px solid var(--accent-border);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      .hospital-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-red);
      }

      .hospital-name {
        font-weight: 600;
        color: var(--primary-red);
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
      }

      .blood-inventory-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      .blood-unit {
        text-align: center;
        padding: 0.5rem;
        background: #f5f5f5;
        border-radius: var(--border-radius-sm);
        font-size: 0.85rem;
      }

      .blood-unit.available {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }

      .blood-unit.low {
        background: #fff3e0;
        color: #e65100;
        border: 1px solid #ff9800;
      }

      .blood-unit.unavailable {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #f44336;
      }

      .campaign-card {
        border: 1px solid var(--accent-border);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
      }

      .campaign-badge {
        background: var(--success-green);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .donation-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .quick-actions {
          grid-template-columns: 1fr;
        }

        .rewards-content {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .blood-inventory-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <!-- User Header (Hospital Style) -->
    <header class="hospital-header">
      <div class="container">
        <nav class="hospital-nav">
          <div class="navbar-brand">
            <div class="logo-icon">
              <i class="fas fa-tint"></i>
            </div>
            <span style="color: #fff">RaktaSewa</span>
          </div>
          <div class="hospital-user-info">
            <div class="hospital-avatar" id="userAvatar">U</div>
            <div>
              <div style="font-weight: 500" id="userName">User</div>
              <div style="font-size: 0.8rem; opacity: 0.8" id="userBloodType">
                Blood Donor
              </div>
            </div>
            <button
              class="btn btn-secondary btn-sm"
              type="button"
              onclick="logout()"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </nav>
      </div>
    </header>

    <div class="dashboard">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul>
            <li class="sidebar-nav-item">
              <a href="dashboard.html" class="sidebar-nav-link active">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="search_blood.html" class="sidebar-nav-link">
                <i class="fas fa-search"></i> Find Blood Banks
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="history.html" class="sidebar-nav-link">
                <i class="fas fa-history"></i> Donation History
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="rewards.html" class="sidebar-nav-link">
                <i class="fas fa-trophy"></i> Rewards & Badges
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="appointments.html" class="sidebar-nav-link">
                <i class="fas fa-calendar-check"></i> Appointments
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a
                href="#"
                onclick="showCampaignsModal()"
                class="sidebar-nav-link"
              >
                <i class="fas fa-bullhorn"></i> Campaigns
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Eligibility Status -->
        <div class="eligibility-status eligible" id="eligibilityStatus">
          <h4>
            <i class="fas fa-check-circle"></i> You are eligible to donate!
          </h4>
          <p id="eligibilityMessage">
            You can donate blood and help save lives.
          </p>
        </div>

        <!-- Next Donation Card -->
        <div class="next-donation-card" id="nextDonationCard">
          <h3><i class="fas fa-calendar-alt"></i> Next Donation Available</h3>
          <div class="countdown-timer" id="countdownTimer">
            <div class="countdown-item">
              <span class="countdown-number" id="days">0</span>
              <span class="countdown-label">Days</span>
            </div>
            <div class="countdown-item">
              <span class="countdown-number" id="hours">0</span>
              <span class="countdown-label">Hours</span>
            </div>
            <div class="countdown-item">
              <span class="countdown-number" id="minutes">0</span>
              <span class="countdown-label">Minutes</span>
            </div>
          </div>
          <p id="nextDonationText">You can donate blood now!</p>
          <button class="btn btn-light btn-lg" onclick="scheduleAppointment()">
            <i class="fas fa-calendar-plus"></i> Schedule Donation
          </button>
        </div>

        <!-- Donation Statistics -->
        <div
          class="donation-stats"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 2.5rem 2.5rem;
            justify-content: space-between;
            align-items: stretch;
            margin-bottom: 2.5rem;
          "
        >
          <div
            class="stat-card-user primary"
            style="flex: 1 1 200px; min-width: 180px"
          >
            <div class="stat-number-large primary" id="totalDonations">0</div>
            <div class="stat-label">Total Donations</div>
          </div>
          <div
            class="stat-card-user success"
            style="flex: 1 1 200px; min-width: 180px"
          >
            <div class="stat-number-large success" id="lifeSaved">0</div>
            <div class="stat-label">Lives Potentially Saved</div>
          </div>
          <div
            class="stat-card-user warning"
            style="flex: 1 1 200px; min-width: 180px"
          >
            <div class="stat-number-large warning" id="rewardPoints">0</div>
            <div class="stat-label">Reward Points</div>
          </div>
          <div
            class="stat-card-user info"
            style="flex: 1 1 200px; min-width: 180px"
          >
            <div class="stat-number-large info" id="consecutiveDonations">
              0
            </div>
            <div class="stat-label">Consecutive Donations</div>
          </div>
        </div>

        <!-- Rewards Summary -->
        <div class="rewards-summary">
          <div class="rewards-content">
            <div>
              <h4><i class="fas fa-trophy"></i> Rewards Summary</h4>
              <div class="rewards-points">
                <span id="totalPoints">0</span> Points
              </div>
            </div>
            <div>
              <button
                class="btn btn-light"
                onclick="window.location.href='rewards.html'"
              >
                <i class="fas fa-gift"></i> View Rewards
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <a href="search_blood.html" class="action-card">
            <div class="action-icon search">
              <i class="fas fa-search"></i>
            </div>
            <h4>Find Blood Banks</h4>
            <p>
              Search for nearby hospitals and blood banks for donation or
              emergency needs
            </p>
          </a>

          <a href="history.html" class="action-card">
            <div class="action-icon history">
              <i class="fas fa-history"></i>
            </div>
            <h4>Donation History</h4>
            <p>
              View your complete donation history and track your contribution
            </p>
          </a>

          <a href="rewards.html" class="action-card">
            <div class="action-icon rewards">
              <i class="fas fa-trophy"></i>
            </div>
            <h4>Rewards & Badges</h4>
            <p>Check your earned badges, rewards, and redeem points</p>
          </a>

          <div class="action-card" onclick="scheduleAppointment()">
            <div class="action-icon schedule">
              <i class="fas fa-calendar-plus"></i>
            </div>
            <h4>Schedule Appointment</h4>
            <p>Book your next blood donation appointment at a nearby center</p>
          </div>
        </div>

        <!-- Blood Compatibility Information -->
        <div class="blood-compatibility-card">
          <h4><i class="fas fa-info-circle"></i> Your Blood Compatibility</h4>
          <div class="compatibility-info">
            <div class="compatibility-item can-donate">
              <h6><i class="fas fa-heart"></i> You Can Donate To</h6>
              <div class="blood-types-list" id="canDonateTo">
                <!-- Will be populated dynamically -->
              </div>
            </div>
            <div class="compatibility-item can-receive">
              <h6>
                <i class="fas fa-hand-holding-heart"></i> You Can Receive From
              </h6>
              <div class="blood-types-list" id="canReceiveFrom">
                <!-- Will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Blood Requests Alert Section -->
        <div
          class="emergency-alerts-section"
          id="emergencyAlertsSection"
          style="display: none"
        >
          <div class="card border-danger">
            <div class="card-header bg-danger text-white">
              <h4 class="mb-0">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="blink-text">URGENT: Emergency Blood Requests</span>
              </h4>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto">
              <div id="emergencyRequestsList">
                <!-- Emergency requests will be loaded dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Nearby Hospitals with Blood Availability -->
        <div class="nearby-hospitals-section mt-4">
          <div class="card">
            <div class="card-header">
              <h4>
                <i class="fas fa-hospital-alt"></i> Nearby Blood Banks &
                Hospitals
              </h4>
              <p class="mb-0 text-muted">
                Real-time blood availability in your area
              </p>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto">
              <div id="nearbyHospitalsList">
                <div class="text-center py-4">
                  <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                  <p class="mt-2">Loading nearby hospitals...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity and Upcoming Campaigns -->
        <div class="row mt-4">
          <div class="col-6">
            <div class="recent-activity">
              <div class="card-header">
                <h4><i class="fas fa-clock"></i> Recent Activity</h4>
              </div>
              <div
                class="card-body"
                style="max-height: 300px; overflow-y: auto"
              >
                <div id="recentActivity">
                  <!-- Activities will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>

          <div class="col-6">
            <div class="upcoming-campaigns">
              <div class="card-header">
                <h4><i class="fas fa-bullhorn"></i> Active Blood Drives</h4>
              </div>
              <div
                class="card-body"
                style="max-height: 300px; overflow-y: auto"
              >
                <div id="upcomingCampaigns">
                  <!-- Campaigns will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user"></i> Profile Information
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="profileContent">
            <!-- Profile content will be loaded here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="editProfile()"
            >
              <i class="fas fa-edit"></i> Edit Profile
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <!-- jQuery (required for Bootstrap modals) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS (required for modals) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Main JS -->
    <script src="../js/main.js"></script>

    <script>
      let userData = null;
      let countdownInterval = null;

      document.addEventListener("DOMContentLoaded", function () {
        // Check user authentication
        checkUserAuth();

        // Load dashboard data
        loadUserStats();
        loadDynamicDashboardData();
        loadRecentActivity();
        loadUpcomingCampaigns();

        // Start countdown timer
        startNextDonationCountdown();

        // Set up auto-refresh
        setInterval(() => {
          loadUserStats();
          loadDynamicDashboardData();
          loadRecentActivity();
        }, 60000); // Refresh every minute
      });

      function checkUserAuth(retryCount = 0) {
        // Ensure Session object is available
        if (typeof Session === "undefined") {
          console.error("Session object not found - main.js may not be loaded");
          setTimeout(() => checkUserAuth(retryCount), 100); // Retry after 100ms
          return;
        }

        Session.checkSession()
          .then((user) => {
            if (!user || user.role !== "donor") {
              // Retry up to 3 times in case of timing issues
              if (retryCount < 3) {
                console.log(
                  `Auth failed - user: ${user}, retrying (${
                    retryCount + 1
                  }/3)...`
                );
                setTimeout(() => checkUserAuth(retryCount + 1), 500);
                return;
              }

              console.log("Auth failed after retries - user:", user);
              Notifications.error("Access Denied", "Donor access required");
              window.location.href = "../login.html?role=donor";
              return;
            }

            userData = user;
            console.log("Authentication successful:", user.username);

            // Update user info
            document.getElementById("userName").textContent = user.full_name;
            document.getElementById("userAvatar").textContent =
              user.full_name && user.full_name.length > 0
                ? user.full_name.charAt(0).toUpperCase()
                : user.username
                ? user.username.charAt(0).toUpperCase()
                : "U";
            document.getElementById("userName").textContent =
              user.full_name && user.full_name.length > 0
                ? user.full_name
                : user.username || "";
            document.getElementById("userBloodType").textContent =
              user.blood_type
                ? `${user.blood_type} Donor`
                : user.role
                ? user.role.charAt(0).toUpperCase() + user.role.slice(1)
                : "Blood Donor";

            // Load blood compatibility
            loadBloodCompatibility(user.blood_type);

            // Check eligibility
            checkEligibility();
          })
          .catch((error) => {
            // Retry up to 3 times in case of timing issues
            if (retryCount < 3) {
              console.log(
                `Session check failed, retrying (${retryCount + 1}/3):`,
                error.message
              );
              setTimeout(() => checkUserAuth(retryCount + 1), 500);
              return;
            }

            console.error("Auth check failed after retries:", error);
            console.log("Redirecting to login due to error:", error.message);
            window.location.href = "../login.html?role=donor";
          });
      }

      function loadUserStats() {
        API.get("get_user_stats.php")
          .then((response) => {
            if (response.success) {
              const stats = response.data;

              document.getElementById("totalDonations").textContent =
                stats.total_donations || 0;
              document.getElementById("lifeSaved").textContent =
                stats.total_donations * 3 || 0; // Assuming 3 lives per donation
              document.getElementById("rewardPoints").textContent =
                stats.reward_points || 0;
              document.getElementById("totalPoints").textContent =
                stats.reward_points || 0;
              document.getElementById("consecutiveDonations").textContent =
                stats.consecutive_donations || 0;
            }
          })
          .catch((error) => {
            console.error("Error loading user stats:", error);
          });
      }

      // Load dynamic dashboard data from hospitals, admin, and emergency requests
      function loadDynamicDashboardData() {
        API.get("get_donor_dashboard_data.php")
          .then((response) => {
            if (response.success) {
              // Display emergency requests
              displayEmergencyRequests(response.emergency_requests || []);

              // Display nearby hospitals
              displayNearbyHospitals(response.nearby_hospitals || []);

              // Update campaigns with enhanced data
              if (
                response.active_campaigns &&
                response.active_campaigns.length > 0
              ) {
                displayActiveCampaigns(response.active_campaigns);
              }

              // Display system alerts
              displaySystemAlerts(response.system_alerts || []);
            }
          })
          .catch((error) => {
            console.error("Error loading dynamic dashboard data:", error);
          });
      }

      function displayEmergencyRequests(requests) {
        const section = document.getElementById("emergencyAlertsSection");
        const container = document.getElementById("emergencyRequestsList");

        if (requests.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";

        container.innerHTML = requests
          .map((request) => {
            const urgencyClass = `urgency-${request.urgency_level}`;
            const timeAgo = calculateTimeAgo(request.created_at);

            return `
            <div class="emergency-request-card">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <span class="urgency-badge ${urgencyClass}">
                    <i class="fas fa-exclamation-circle"></i> ${request.urgency_level.toUpperCase()}
                  </span>
                  <h5 class="mt-2 mb-1">
                    <i class="fas fa-tint text-danger"></i> ${
                      request.blood_type
                    } Blood Needed
                  </h5>
                </div>
                <div class="text-right">
                  <strong>${request.units_needed} Units</strong>
                </div>
              </div>
              <p class="mb-2">
                <i class="fas fa-hospital"></i> <strong>${
                  request.hospital_name || "Hospital"
                }</strong><br>
                <i class="fas fa-map-marker-alt"></i> ${
                  request.location || request.city || "Location not specified"
                }
              </p>
              ${
                request.notes
                  ? `<p class="text-muted small mb-2">${request.notes}</p>`
                  : ""
              }
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  <i class="fas fa-clock"></i> ${timeAgo}
                </small>
                <div>
                  <a href="tel:${
                    request.hospital_phone || request.phone
                  }" class="btn btn-sm btn-outline-primary mr-2">
                    <i class="fas fa-phone"></i> Contact
                  </a>
                  <button class="btn btn-sm btn-danger" onclick="respondToEmergency(${
                    request.id
                  })">
                    <i class="fas fa-hand-holding-heart"></i> Respond
                  </button>
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function displayNearbyHospitals(hospitals) {
        const container = document.getElementById("nearbyHospitalsList");

        if (hospitals.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-hospital-alt fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No nearby hospitals found</h5>
              <p class="text-muted">We couldn't find hospitals in your area at this moment.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = hospitals
          .map((hospital) => {
            const inventory = hospital.blood_inventory || {};
            const bloodTypes = [
              "A+",
              "A-",
              "B+",
              "B-",
              "AB+",
              "AB-",
              "O+",
              "O-",
            ];

            return `
            <div class="hospital-card">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <div class="hospital-name">
                    <i class="fas fa-hospital"></i> ${hospital.hospital_name}
                  </div>
                  <p class="mb-1 text-muted small">
                    <i class="fas fa-map-marker-alt"></i> ${
                      hospital.address
                    }, ${hospital.city}
                  </p>
                  <p class="mb-2 text-muted small">
                    <i class="fas fa-phone"></i> ${
                      hospital.contact_phone || "N/A"
                    } â€¢ 
                    <i class="fas fa-envelope"></i> ${hospital.email || "N/A"}
                  </p>
                </div>
                <button class="btn btn-sm btn-primary" onclick="scheduleHospitalAppointment(${
                  hospital.id
                })">
                  <i class="fas fa-calendar-plus"></i> Book
                </button>
              </div>
              
              <div class="mt-3">
                <strong class="text-muted small">Blood Availability:</strong>
                <div class="blood-inventory-grid">
                  ${bloodTypes
                    .map((type) => {
                      const units = inventory[type] || 0;
                      const statusClass =
                        units > 10
                          ? "available"
                          : units > 0
                          ? "low"
                          : "unavailable";
                      return `
                      <div class="blood-unit ${statusClass}">
                        <strong>${type}</strong><br>
                        <span>${units > 0 ? units + " units" : "Out"}</span>
                      </div>
                    `;
                    })
                    .join("")}
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function displayActiveCampaigns(campaigns) {
        const container = document.getElementById("upcomingCampaigns");

        if (campaigns.length === 0) {
          container.innerHTML = '<p class="text-muted">No active campaigns</p>';
          return;
        }

        container.innerHTML = campaigns
          .map((campaign) => {
            const progress =
              campaign.target_donors > 0
                ? Math.round(
                    (campaign.current_donors / campaign.target_donors) * 100
                  )
                : 0;

            return `
            <div class="campaign-card">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <span class="campaign-badge">ACTIVE</span>
                  <h6 class="mt-2 mb-0">${campaign.title}</h6>
                </div>
                <span class="badge badge-info">${
                  campaign.days_remaining
                } days left</span>
              </div>
              <p class="small text-muted mb-2">
                <i class="fas fa-hospital"></i> ${campaign.hospital_name}<br>
                <i class="fas fa-map-marker-alt"></i> ${campaign.city}
              </p>
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-success" style="width: ${progress}%"></div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  ${campaign.current_donors || 0} / ${
              campaign.target_donors || 100
            } donors
                </small>
                <button class="btn btn-sm btn-success" onclick="joinCampaign(${
                  campaign.id
                })">
                  <i class="fas fa-plus"></i> Join
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function displaySystemAlerts(alerts) {
        if (alerts.length > 0) {
          // Show toast notifications for critical alerts
          alerts.forEach((alert) => {
            if (alert.severity === "high" && alert.type === "critical") {
              setTimeout(() => {
                Notifications.warning(alert.title, alert.message);
              }, 1000);
            }
          });
        }
      }

      function calculateTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return "Just now";
        if (seconds < 3600) return Math.floor(seconds / 60) + " minutes ago";
        if (seconds < 86400) return Math.floor(seconds / 3600) + " hours ago";
        return Math.floor(seconds / 86400) + " days ago";
      }

      function respondToEmergency(requestId) {
        Notifications.confirm(
          "Respond to Emergency Request",
          "Are you ready to donate blood for this emergency request? We will connect you with the hospital.",
          "Yes, I'm Ready",
          "error"
        ).then((result) => {
          if (result.isConfirmed) {
            API.post("respond_emergency_request.php", {
              request_id: requestId,
              response: "willing_to_donate",
            })
              .then((response) => {
                if (response.success) {
                  Notifications.success(
                    "Response Sent!",
                    "Thank you! The hospital has been notified and will contact you shortly."
                  );
                  loadDynamicDashboardData(); // Refresh data
                } else {
                  throw new Error(response.message);
                }
              })
              .catch((error) => {
                Notifications.error(
                  "Error",
                  "Failed to send response: " + error.message
                );
              });
          }
        });
      }

      function scheduleHospitalAppointment(hospitalId) {
        // This would open the appointment modal with the hospital pre-selected
        scheduleAppointment(hospitalId);
      }

      function joinCampaign(campaignId) {
        Notifications.confirm(
          "Join Campaign",
          "Would you like to participate in this blood donation campaign?",
          {
            confirmButtonText: "Yes, Join Campaign",
            icon: "success",
          }
        ).then((result) => {
          if (result.isConfirmed) {
            API.post("register_campaign.php", { campaign_id: campaignId })
              .then((response) => {
                if (response.success) {
                  Notifications.success(
                    "Success",
                    "You have been registered for the campaign!"
                  );
                  loadDynamicDashboardData(); // Refresh data
                } else {
                  // Show detailed error message
                  const errorMsg = response.error
                    ? `${response.message} (${response.error})`
                    : response.message;
                  throw new Error(errorMsg);
                }
              })
              .catch((error) => {
                Notifications.error(
                  "Registration Failed",
                  error.message || "Failed to register for campaign"
                );
              });
          }
        });
      }

      function checkEligibility() {
        API.get("check_donation_eligibility.php")
          .then((response) => {
            if (response.success) {
              const eligibility = response.data;
              const statusDiv = document.getElementById("eligibilityStatus");
              const messageEl = document.getElementById("eligibilityMessage");

              statusDiv.className = `eligibility-status ${eligibility.status}`;

              switch (eligibility.status) {
                case "eligible":
                  statusDiv.innerHTML =
                    '<h4><i class="fas fa-check-circle"></i> You are eligible to donate!</h4>';
                  messageEl.textContent =
                    "You can donate blood and help save lives.";
                  break;
                case "ineligible":
                  statusDiv.innerHTML =
                    '<h4><i class="fas fa-times-circle"></i> Currently Ineligible</h4>';
                  messageEl.textContent =
                    eligibility.reason ||
                    "Please wait before your next donation.";
                  break;
                case "pending":
                  statusDiv.innerHTML =
                    '<h4><i class="fas fa-clock"></i> Eligibility Pending</h4>';
                  messageEl.textContent = "Your eligibility is being reviewed.";
                  break;
              }
            }
          })
          .catch((error) => {
            console.error("Error checking eligibility:", error);
          });
      }

      function startNextDonationCountdown() {
        API.get("get_next_donation_date.php")
          .then((response) => {
            if (response.success) {
              const nextDate = new Date(response.data.next_donation_date);
              const now = new Date();

              if (nextDate <= now) {
                // Can donate now
                document.getElementById("nextDonationText").textContent =
                  "You can donate blood now!";
                document.getElementById("countdownTimer").style.display =
                  "none";
              } else {
                // Start countdown
                countdownInterval = setInterval(() => {
                  updateCountdown(nextDate);
                }, 1000);
              }
            }
          })
          .catch((error) => {
            console.error("Error loading next donation date:", error);
          });
      }

      function updateCountdown(targetDate) {
        const now = new Date().getTime();
        const distance = targetDate.getTime() - now;

        if (distance < 0) {
          // Countdown finished
          clearInterval(countdownInterval);
          document.getElementById("nextDonationText").textContent =
            "You can donate blood now!";
          document.getElementById("countdownTimer").style.display = "none";
          return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById("days").textContent = days;
        document.getElementById("hours").textContent = hours;
        document.getElementById("minutes").textContent = minutes;
      }

      function loadBloodCompatibility(bloodType) {
        if (!bloodType) return;

        const compatibilityData = {
          "O-": {
            canDonateTo: ["O-", "O+", "A-", "A+", "B-", "B+", "AB-", "AB+"],
            canReceiveFrom: ["O-"],
          },
          "O+": {
            canDonateTo: ["O+", "A+", "B+", "AB+"],
            canReceiveFrom: ["O-", "O+"],
          },
          "A-": {
            canDonateTo: ["A-", "A+", "AB-", "AB+"],
            canReceiveFrom: ["O-", "A-"],
          },
          "A+": {
            canDonateTo: ["A+", "AB+"],
            canReceiveFrom: ["O-", "O+", "A-", "A+"],
          },
          "B-": {
            canDonateTo: ["B-", "B+", "AB-", "AB+"],
            canReceiveFrom: ["O-", "B-"],
          },
          "B+": {
            canDonateTo: ["B+", "AB+"],
            canReceiveFrom: ["O-", "O+", "B-", "B+"],
          },
          "AB-": {
            canDonateTo: ["AB-", "AB+"],
            canReceiveFrom: ["O-", "A-", "B-", "AB-"],
          },
          "AB+": {
            canDonateTo: ["AB+"],
            canReceiveFrom: ["O-", "O+", "A-", "A+", "B-", "B+", "AB-", "AB+"],
          },
        };

        const compatibility = compatibilityData[bloodType];
        if (compatibility) {
          document.getElementById("canDonateTo").innerHTML =
            compatibility.canDonateTo
              .map((type) => `<span class="blood-type-tag">${type}</span>`)
              .join("");

          document.getElementById("canReceiveFrom").innerHTML =
            compatibility.canReceiveFrom
              .map((type) => `<span class="blood-type-tag">${type}</span>`)
              .join("");
        }
      }

      function loadRecentActivity() {
        API.get("get_user_activities.php", { limit: 5 })
          .then((response) => {
            if (response.success) {
              displayRecentActivity(response.data);
            }
          })
          .catch((error) => {
            console.error("Error loading recent activity:", error);
          });
      }

      function displayRecentActivity(activities) {
        const container = document.getElementById("recentActivity");

        if (activities.length === 0) {
          container.innerHTML =
            '<p class="text-muted">No recent activities</p>';
          return;
        }

        container.innerHTML = activities
          .map(
            (activity) => `
                <div class="activity-item">
                    <div class="activity-icon ${getActivityClass(
                      activity.activity_type
                    )}">
                        <i class="fas fa-${getActivityIcon(
                          activity.activity_type
                        )}"></i>
                    </div>
                    <div class="activity-content">
                        <div>${formatActivityText(activity)}</div>
                        <small class="text-muted">${Utils.timeAgo(
                          activity.created_at
                        )}</small>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function getActivityClass(type) {
        const classes = {
          donation: "donation",
          appointment: "appointment",
          reward_earned: "reward",
          registration: "appointment",
        };
        return classes[type] || "appointment";
      }

      function getActivityIcon(type) {
        const icons = {
          donation: "tint",
          appointment: "calendar-check",
          reward_earned: "trophy",
          registration: "user-plus",
        };
        return icons[type] || "circle";
      }

      function formatActivityText(activity) {
        switch (activity.activity_type) {
          case "donation":
            return `Blood donation completed at ${
              activity.location || "hospital"
            }`;
          case "appointment":
            return `Appointment scheduled for ${Utils.formatDate(
              activity.appointment_date
            )}`;
          case "reward_earned":
            return `Earned ${activity.points} reward points - ${activity.description}`;
          case "registration":
            return "Registered as a blood donor";
          default:
            return activity.description || "Activity recorded";
        }
      }

      function loadUpcomingCampaigns() {
        API.get("get_user_campaigns.php", { limit: 5 })
          .then((response) => {
            if (response.success) {
              displayUpcomingCampaigns(response.data);
            }
          })
          .catch((error) => {
            console.error("Error loading campaigns:", error);
          });
      }

      function displayUpcomingCampaigns(campaigns) {
        const container = document.getElementById("upcomingCampaigns");

        if (campaigns.length === 0) {
          container.innerHTML =
            '<p class="text-muted">No upcoming campaigns</p>';
          return;
        }

        container.innerHTML = campaigns
          .map(
            (campaign) => `
                <div class="campaign-item">
                    <div class="campaign-info">
                        <div class="campaign-title">${Utils.escapeHtml(
                          campaign.title
                        )}</div>
                        <div class="campaign-meta">
                            <i class="fas fa-map-marker-alt"></i> ${Utils.escapeHtml(
                              campaign.location
                            )} â€¢ 
                            <i class="fas fa-calendar"></i> ${Utils.formatDate(
                              campaign.start_date
                            )}
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="registerForCampaign(${
                      campaign.id
                    })">
                        <i class="fas fa-plus"></i> Join
                    </button>
                </div>
            `
          )
          .join("");
      }

      function registerForCampaign(campaignId) {
        Notifications.confirm(
          "Join Campaign",
          "Would you like to register for this blood donation campaign?",
          "Yes, Join Campaign",
          "success"
        ).then((result) => {
          if (result.isConfirmed) {
            API.post("register_campaign.php", { campaign_id: campaignId })
              .then((response) => {
                if (response.success) {
                  Notifications.success(
                    "Success",
                    "You have been registered for the campaign!"
                  );
                  loadUpcomingCampaigns(); // Refresh the list
                } else {
                  throw new Error(response.message);
                }
              })
              .catch((error) => {
                console.error("Error registering for campaign:", error);
                Notifications.error(
                  "Error",
                  "Failed to register: " + error.message
                );
              });
          }
        });
      }

      function scheduleAppointment() {
        const appointmentModal = document.createElement("div");
        appointmentModal.className = "modal fade";
        appointmentModal.id = "appointmentModal";
        appointmentModal.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                  <i class="fas fa-calendar-plus"></i> Schedule Blood Donation Appointment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="appointmentForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="appointmentDate">
                          <i class="fas fa-calendar"></i> Preferred Date
                        </label>
                        <input type="date" class="form-control" id="appointmentDate" required
                               min="${
                                 new Date(Date.now() + 24 * 60 * 60 * 1000)
                                   .toISOString()
                                   .split("T")[0]
                               }">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="appointmentTime">
                          <i class="fas fa-clock"></i> Preferred Time
                        </label>
                        <select class="form-control" id="appointmentTime" required>
                          <option value="">Select time slot</option>
                          <option value="09:00">9:00 AM</option>
                          <option value="10:00">10:00 AM</option>
                          <option value="11:00">11:00 AM</option>
                          <option value="14:00">2:00 PM</option>
                          <option value="15:00">3:00 PM</option>
                          <option value="16:00">4:00 PM</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="donationCenter">
                      <i class="fas fa-hospital"></i> Donation Center
                    </label>
                    <select class="form-control" id="donationCenter" required>
                      <option value="">Loading hospitals...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="bloodType">
                      <i class="fas fa-tint"></i> Blood Type
                    </label>
                    <input type="text" class="form-control" id="bloodType" required readonly>
                    <small class="form-text text-muted">Your blood type from profile</small>
                  </div>
                  <div class="form-group">
                    <label for="specialRequests">
                      <i class="fas fa-comment"></i> Special Requests or Notes
                    </label>
                    <textarea class="form-control" id="specialRequests" rows="3" 
                              placeholder="Any special requirements or medical notes..."></textarea>
                  </div>
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Important:</strong> Please ensure you meet the donation criteria:
                    <ul class="mb-0 mt-2">
                      <li>Be at least 18 years old (16-17 with parental consent)</li>
                      <li>Weigh at least 110 pounds</li>
                      <li>Be in good general health</li>
                      <li>Have not donated blood in the last 56 days (whole blood)</li>
                    </ul>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                  <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitAppointment()">
                  <i class="fas fa-check"></i> Schedule Appointment
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(appointmentModal);
        $(appointmentModal).modal("show");

        // Load hospitals into the dropdown
        loadHospitalsForAppointment();

        // Load user's blood type
        loadUserBloodType();

        // Remove modal from DOM when hidden
        $(appointmentModal).on("hidden.bs.modal", function () {
          document.body.removeChild(appointmentModal);
        });
      }

      function loadUserBloodType() {
        const input = document.getElementById("bloodType");

        console.log("loadUserBloodType called - userData:", userData);

        // Check if userData has blood_type
        if (userData && userData.blood_type) {
          input.value = userData.blood_type;
          console.log(
            "âœ“ Blood type loaded from userData:",
            userData.blood_type
          );
          return;
        }

        // If userData exists but no blood_type, fetch from API
        if (userData) {
          console.log("Fetching blood type from API...");
          API.get("get_user_stats.php")
            .then((response) => {
              console.log("API response:", response);
              if (
                response.success &&
                response.data &&
                response.data.user_info &&
                response.data.user_info.blood_type &&
                response.data.user_info.blood_type !== "Not specified"
              ) {
                input.value = response.data.user_info.blood_type;
                // Update userData for future use
                userData.blood_type = response.data.user_info.blood_type;
                console.log(
                  "âœ“ Blood type loaded from API:",
                  response.data.user_info.blood_type
                );
              } else {
                input.value = "Not set";
                input.placeholder = "Please update your profile";
                console.warn("No blood type found in API response:", response);
              }
            })
            .catch((error) => {
              console.error("Error loading blood type:", error);
              input.value = "Error loading";
              input.placeholder = "Unable to load blood type";
            });
          return;
        }

        // userData not available yet, wait and try again
        console.log("userData not available yet, waiting...");
        setTimeout(() => {
          loadUserBloodType(); // Retry
        }, 500);
      }

      function populateBloodTypeDropdown(userBloodType) {
        // This function is no longer needed but kept for compatibility
        const input = document.getElementById("bloodType");
        if (input && userBloodType) {
          input.value = userBloodType;
        }
      }

      function loadHospitalsForAppointment() {
        const select = document.getElementById("donationCenter");

        API.get("get_hospitals.php", { limit: 100 })
          .then((response) => {
            if (response.success && response.data && response.data.hospitals) {
              const hospitals = response.data.hospitals;

              if (hospitals.length === 0) {
                select.innerHTML =
                  '<option value="">No hospitals available</option>';
                return;
              }

              select.innerHTML =
                '<option value="">Select donation center</option>';

              hospitals.forEach((hospital) => {
                const option = document.createElement("option");
                option.value = hospital.id;
                option.textContent = `${hospital.hospital_name} - ${hospital.city}`;
                option.dataset.address = hospital.address;
                option.dataset.phone = hospital.contact_phone || hospital.phone;
                select.appendChild(option);
              });
            } else {
              select.innerHTML =
                '<option value="">No hospitals available</option>';
            }
          })
          .catch((error) => {
            console.error("Error loading hospitals:", error);
            select.innerHTML =
              '<option value="">Error loading hospitals</option>';
          });
      }

      function showProfileModal() {
        if (!userData) return;

        const content = document.getElementById("profileContent");
        content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user"></i> Personal Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Full Name:</strong></td><td>${Utils.escapeHtml(
                              userData.full_name
                            )}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${Utils.escapeHtml(
                              userData.email
                            )}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${Utils.escapeHtml(
                              userData.phone
                            )}</td></tr>
                            <tr><td><strong>Blood Type:</strong></td><td><span class="blood-type-badge">${
                              userData.blood_type
                            }</span></td></tr>
                            <tr><td><strong>Date of Birth:</strong></td><td>${Utils.formatDate(
                              userData.date_of_birth
                            )}</td></tr>
                            <tr><td><strong>Gender:</strong></td><td>${Utils.escapeHtml(
                              userData.gender
                            )}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt"></i> Address Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Address:</strong></td><td>${Utils.escapeHtml(
                              userData.address || "Not provided"
                            )}</td></tr>
                            <tr><td><strong>City:</strong></td><td>${Utils.escapeHtml(
                              userData.city || "Not provided"
                            )}</td></tr>
                            <tr><td><strong>State:</strong></td><td>${Utils.escapeHtml(
                              userData.state || "Not provided"
                            )}</td></tr>
                            <tr><td><strong>Postal Code:</strong></td><td>${Utils.escapeHtml(
                              userData.postal_code || "Not provided"
                            )}</td></tr>
                        </table>
                        
                        <h6 class="mt-3"><i class="fas fa-info-circle"></i> Account Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Member Since:</strong></td><td>${Utils.formatDate(
                              userData.created_at
                            )}</td></tr>
                            <tr><td><strong>Last Updated:</strong></td><td>${Utils.formatDate(
                              userData.updated_at
                            )}</td></tr>
                            <tr><td><strong>Account Status:</strong></td><td><span class="badge badge-success">Active</span></td></tr>
                        </table>
                    </div>
                </div>
            `;

        $("#profileModal").modal("show");
      }

      function editProfile() {
        Notifications.info(
          "Edit Profile",
          "Profile editing feature coming soon!"
        );
      }

      // Modal functions for other features
      function showAppointmentModal() {
        // Redirect to dedicated appointments page
        window.location.href = "appointments.html";
      }

      // Legacy appointment modal function (kept for backward compatibility)
      function showAppointmentModalOld() {
        const appointmentModal = document.createElement("div");
        appointmentModal.className = "modal fade";
        appointmentModal.id = "appointmentManagementModal";
        appointmentModal.innerHTML = `
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                  <i class="fas fa-calendar-check"></i> My Appointments
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <div>
                    <h6 class="mb-1">Appointment Management</h6>
                    <small class="text-muted">View, schedule, and manage your blood donation appointments</small>
                  </div>
                  <button class="btn btn-primary" onclick="$(this).closest('.modal').modal('hide'); scheduleAppointment();">
                    <i class="fas fa-plus"></i> New Appointment
                  </button>
                </div>
                
                <div class="row mb-4">
                  <div class="col-md-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h4 class="text-primary mb-1" id="upcomingCount">2</h4>
                        <small class="text-muted">Upcoming</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h4 class="text-success mb-1" id="completedCount">5</h4>
                        <small class="text-muted">Completed</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h4 class="text-warning mb-1" id="cancelledCount">1</h4>
                        <small class="text-muted">Cancelled</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h4 class="text-info mb-1" id="totalCount">8</h4>
                        <small class="text-muted">Total</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <ul class="nav nav-tabs mb-3" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#upcoming-appointments">
                      <i class="fas fa-clock"></i> Upcoming
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#past-appointments">
                      <i class="fas fa-history"></i> History
                    </a>
                  </li>
                </ul>
                
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="upcoming-appointments">
                    <div class="appointment-list" id="upcomingAppointmentsList">
                      <!-- Upcoming appointments will be loaded here -->
                    </div>
                  </div>
                  <div class="tab-pane fade" id="past-appointments">
                    <div class="appointment-list" id="pastAppointmentsList">
                      <!-- Past appointments will be loaded here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(appointmentModal);
        $(appointmentModal).modal("show");

        // Load appointments data
        loadAppointments();

        // Remove modal from DOM when hidden
        $(appointmentModal).on("hidden.bs.modal", function () {
          document.body.removeChild(appointmentModal);
        });
      }

      // Helper functions for appointment system
      function getCurrentUserId() {
        // Try to get user ID from session
        if (typeof Session !== "undefined" && Session.isLoggedIn()) {
          const user = Session.getCurrentUser();
          console.log("Dashboard - Current user object:", user);

          // Check for user_id (returned by check_session.php)
          if (user && user.user_id) {
            console.log("Using logged-in user ID:", user.user_id);
            return user.user_id;
          }
        }

        // Fallback to default donor ID for testing
        console.warn(
          "Using default user ID. In production, user should be logged in."
        );
        return 3; // Using actual donor ID from database (Aayushman)
      }

      function getUserBloodType() {
        // Try to get blood type from session
        if (typeof Session !== "undefined" && Session.isLoggedIn()) {
          const user = Session.getCurrentUser();
          if (user && user.blood_type) {
            return user.blood_type;
          }
        }

        // Fallback to default blood type
        console.warn(
          "Using default blood type. User should have blood type in profile."
        );
        return "O+"; // Most common blood type
      }

      function getHospitalIdByCode(centerCode) {
        // Map center codes to hospital IDs from database
        const hospitalMap = {
          "city-general": 1, // Central Medical Center
          "patan-community": 2, // Patan Community Hospital
          "nima-hospital": 3, // Nima Hospital
          "sherpa-hospital": 4, // Sherpa Hospital
          "red-cross": 1, // Default to Central Medical Center
          "metro-medical": 2, // Default to Patan Community Hospital
        };
        return hospitalMap[centerCode] || 1; // Default to hospital ID 1
      }

      function submitAppointment() {
        const form = document.getElementById("appointmentForm");
        const formData = new FormData(form);

        // Validate form
        const date = document.getElementById("appointmentDate").value;
        const time = document.getElementById("appointmentTime").value;
        const center = document.getElementById("donationCenter").value;
        const bloodType = document.getElementById("bloodType").value;

        if (!date || !time || !center || !bloodType) {
          Notifications.error(
            "Validation Error",
            "Please fill in all required fields."
          );
          return;
        }

        // Show loading
        const submitBtn = event.target;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
        submitBtn.disabled = true;

        // Prepare appointment data for database
        const appointmentData = {
          donor_id: getCurrentUserId(),
          hospital_id: center, // Use the selected hospital ID directly
          appointment_date: date,
          appointment_time: time + ":00", // Add seconds for Y-m-d H:i:s format
          blood_type: bloodType, // Use the selected blood type from form
          notes: document.getElementById("specialRequests").value,
          contact_person: "",
          contact_phone: "",
        };

        console.log("Sending appointment data:", appointmentData);

        // Make API call to create appointment in database
        fetch("../php/create_appointment.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(appointmentData),
        })
          .then((response) => {
            console.log("API Response status:", response.status);
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log("API Response data:", data);

            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            if (data.success) {
              // Success notification
              Notifications.success(
                "Appointment Scheduled!",
                `Your appointment has been scheduled for ${Utils.formatDate(
                  date
                )} at ${Utils.formatTime(time)}. Appointment ID: ${
                  data.appointment_id
                }`
              );

              // Close modal
              $("#appointmentModal").modal("hide");

              // Reload appointments if appointment management modal is open
              // Use setTimeout to ensure modal animations complete
              setTimeout(() => {
                if ($("#appointmentManagementModal").hasClass("show")) {
                  loadAppointments();
                }
              }, 500);

              // Update dashboard stats
              updateDashboardStats();
            } else {
              Notifications.error(
                "Scheduling Failed",
                data.message ||
                  "Failed to schedule appointment. Please try again."
              );
            }
          })
          .catch((error) => {
            console.error("Error scheduling appointment:", error);

            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            Notifications.error(
              "Scheduling Failed",
              `An error occurred: ${error.message}. Please check the console for details.`
            );
          });
      }

      function loadAppointments() {
        const userId = getCurrentUserId();
        if (!userId) {
          console.error("User ID not found");
          return;
        }

        // Fetch appointments from PHP API
        fetch(`../php/get_appointments.php?user_id=${userId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const appointments = data.appointments;

              // Display upcoming and past appointments
              displayAppointments(
                appointments.upcoming,
                "upcomingAppointmentsList",
                true
              );
              displayAppointments(
                appointments.past,
                "pastAppointmentsList",
                false
              );

              // Update counters
              document.getElementById("upcomingCount").textContent =
                appointments.upcoming.length;
              document.getElementById("completedCount").textContent =
                data.stats.completed;
              document.getElementById("cancelledCount").textContent =
                appointments.past.filter(
                  (a) => a.status === "cancelled"
                ).length;
              document.getElementById("totalCount").textContent =
                data.stats.total;
            } else {
              console.error("Failed to load appointments:", data.message);
              // Show empty state
              displayAppointments([], "upcomingAppointmentsList", true);
              displayAppointments([], "pastAppointmentsList", false);
            }
          })
          .catch((error) => {
            console.error("Error loading appointments:", error);
            // Show empty state on error
            displayAppointments([], "upcomingAppointmentsList", true);
            displayAppointments([], "pastAppointmentsList", false);
          });
      }

      function displayAppointments(appointments, containerId, isUpcoming) {
        const container = document.getElementById(containerId);

        // Check if container exists
        if (!container) {
          console.error(`Container element '${containerId}' not found`);
          return;
        }

        if (appointments.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No ${
                isUpcoming ? "upcoming" : "past"
              } appointments</h5>
              <p class="text-muted">${
                isUpcoming
                  ? "Schedule your next blood donation appointment to help save lives."
                  : "Your completed and cancelled appointments will appear here."
              }</p>
              ${
                isUpcoming
                  ? '<button class="btn btn-primary" onclick="scheduleAppointment()"><i class="fas fa-plus"></i> Schedule Now</button>'
                  : ""
              }
            </div>
          `;
          return;
        }

        container.innerHTML = appointments
          .map((appointment) => {
            const statusClass =
              {
                scheduled: "primary",
                confirmed: "info",
                completed: "success",
                cancelled: "danger",
                rescheduled: "warning",
                no_show: "dark",
              }[appointment.status] || "secondary";

            return `
            <div class="card mb-3">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <div class="d-flex align-items-center mb-2">
                      <span class="badge badge-${statusClass} mr-2">${appointment.status.toUpperCase()}</span>
                      <h6 class="mb-0">${
                        appointment.hospital
                          ? appointment.hospital.name
                          : "Hospital"
                      }</h6>
                    </div>
                    <div class="row">
                      <div class="col-sm-6">
                        <small class="text-muted d-block">
                          <i class="fas fa-calendar"></i> ${
                            appointment.formatted_date || appointment.date
                          }
                        </small>
                        <small class="text-muted d-block">
                          <i class="fas fa-clock"></i> ${
                            appointment.formatted_time || appointment.time
                          }
                        </small>
                      </div>
                      <div class="col-sm-6">
                        <small class="text-muted d-block">
                          <i class="fas fa-tint"></i> ${
                            appointment.blood_type
                          } Blood Type
                        </small>
                        <small class="text-muted d-block">
                          <i class="fas fa-hashtag"></i> APT-${appointment.id
                            .toString()
                            .padStart(3, "0")}
                        </small>
                      </div>
                    </div>
                    ${
                      appointment.hospital && appointment.hospital.address
                        ? `
                      <small class="text-muted d-block mt-1">
                        <i class="fas fa-map-marker-alt"></i> ${appointment.hospital.address}, ${appointment.hospital.city}
                      </small>
                    `
                        : ""
                    }
                    ${
                      appointment.notes
                        ? `<small class="text-muted mt-1 d-block"><i class="fas fa-comment"></i> ${appointment.notes}</small>`
                        : ""
                    }
                  </div>
                  <div class="col-md-4 text-right">
                    ${
                      isUpcoming && appointment.status === "scheduled"
                        ? `
                      <button class="btn btn-sm btn-outline-primary mr-1" onclick="editAppointment(${appointment.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="cancelAppointment(${appointment.id})" title="Cancel">
                        <i class="fas fa-times"></i>
                      </button>
                    `
                        : `
                      <small class="text-muted d-block">Created</small>
                      <small class="text-muted">${
                        appointment.created_at
                          ? new Date(
                              appointment.created_at
                            ).toLocaleDateString()
                          : ""
                      }</small>
                    `
                    }
                  </div>
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function cancelAppointment(appointmentId) {
        Notifications.confirm(
          "Cancel Appointment",
          "Are you sure you want to cancel this appointment? This action cannot be undone."
        ).then((result) => {
          if (result.isConfirmed) {
            // Call PHP API to cancel appointment
            fetch("../php/update_appointment.php", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                appointment_id: appointmentId,
                action: "cancel",
                user_id: getCurrentUserId(),
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  Notifications.success(
                    "Appointment Cancelled",
                    "Your appointment has been cancelled successfully."
                  );
                  loadAppointments(); // Refresh the list
                  updateDashboardStats();
                } else {
                  Notifications.error(
                    "Cancellation Failed",
                    data.message ||
                      "Failed to cancel appointment. Please try again."
                  );
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                Notifications.error(
                  "Cancellation Failed",
                  "An error occurred while cancelling your appointment. Please try again."
                );
              });
          }
        });
      }

      function showCampaignsModal() {
        window.location.href = "campaigns.html";
      }

      function logout() {
        Notifications.confirm(
          "Logout",
          "Are you sure you want to logout?"
        ).then((result) => {
          if (result.isConfirmed) {
            Session.logout()
              .then(() => {
                window.location.href = "../index.html";
              })
              .catch(() => {
                window.location.href = "../index.html";
              });
          }
        });
      }

      // Extend Utils with additional formatting functions if needed
      if (typeof Utils !== "undefined") {
        // Add formatTime function if it doesn't exist
        if (!Utils.formatTime) {
          Utils.formatTime = function (timeString) {
            const [hours, minutes] = timeString.split(":");
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes));
            return date.toLocaleTimeString("en-US", {
              hour: "numeric",
              minute: "2-digit",
              hour12: true,
            });
          };
        }

        // Override formatDate for more detailed format if needed
        Utils.formatDateLong = function (dateString) {
          const date = new Date(dateString);
          const options = {
            year: "numeric",
            month: "long",
            day: "numeric",
            weekday: "long",
          };
          return date.toLocaleDateString("en-US", options);
        };
      }

      // Update dashboard stats after appointment changes
      function updateDashboardStats() {
        // This would typically refresh dashboard statistics
        console.log("Dashboard stats updated");
      }
    </script>
  </body>
</html>
