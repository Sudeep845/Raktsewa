<!DOCTYPE html>
<html>
  <head>
    <title>Debug Donor Redirect Issue</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .debug-section {
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
      }
      .error {
        background: #f8d7da;
      }
      .warning {
        background: #fff3cd;
      }
      .info {
        background: #d1ecf1;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-size: 11px;
        overflow-x: auto;
      }
      .log {
        background: #f1f3f4;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
        height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>üîç Debug Donor Redirect Issue</h1>

    <div class="debug-section info">
      <h3>Current Status</h3>
      <p><strong>Page:</strong> <span id="currentPage"></span></p>
      <p><strong>Time:</strong> <span id="currentTime"></span></p>
      <button onclick="runCompleteDebug()">üöÄ Run Complete Debug</button>
      <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    </div>

    <div class="debug-section">
      <h3>Step 1: Login Test</h3>
      <button onclick="testLogin()">üîê Test Login</button>
      <div id="loginResult"></div>
    </div>

    <div class="debug-section">
      <h3>Step 2: Raw Session Check</h3>
      <button onclick="testRawSession()" disabled id="rawSessionBtn">
        üîç Check Raw Session
      </button>
      <div id="rawSessionResult"></div>
    </div>

    <div class="debug-section">
      <h3>Step 3: main.js Session Check</h3>
      <button onclick="testMainJsSession()" disabled id="mainJsBtn">
        üìã Test main.js Session
      </button>
      <div id="mainJsResult"></div>
    </div>

    <div class="debug-section">
      <h3>Step 4: Simulate Dashboard Auth</h3>
      <button onclick="simulateDashboardAuth()" disabled id="dashboardAuthBtn">
        üéØ Simulate Dashboard Auth
      </button>
      <div id="dashboardAuthResult"></div>
    </div>

    <div class="debug-section">
      <h3>Debug Log</h3>
      <div id="debugLog" class="log"></div>
    </div>

    <!-- Include main.js to access Session object -->
    <script src="../js/main.js"></script>

    <script>
      document.getElementById("currentPage").textContent = window.location.href;
      document.getElementById("currentTime").textContent =
        new Date().toLocaleString();

      function log(message, type = "info") {
        const logDiv = document.getElementById("debugLog");
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "error"
            ? "color: red"
            : type === "success"
            ? "color: green"
            : "color: black";
        logDiv.innerHTML += `<div style="${className}"><strong>[${timestamp}]</strong> ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
      }

      function clearLogs() {
        document.getElementById("debugLog").innerHTML = "";
      }

      async function runCompleteDebug() {
        log("=== STARTING COMPLETE DEBUG SEQUENCE ===", "info");
        clearLogs();
        await testLogin();
        await sleep(1000);
        await testRawSession();
        await sleep(1000);
        await testMainJsSession();
        await sleep(1000);
        await simulateDashboardAuth();
        log("=== DEBUG SEQUENCE COMPLETE ===", "info");
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function testLogin() {
        log("Testing donor login...", "info");
        const resultDiv = document.getElementById("loginResult");

        try {
          const formData = new FormData();
          formData.append("username", "donor1");
          formData.append("password", "password");
          formData.append("role", "donor");

          log("Sending login request to php/login.php", "info");

          const response = await fetch("../php/login.php", {
            method: "POST",
            body: formData,
            credentials: "include",
          });

          const data = await response.json();
          log(`Login response: ${JSON.stringify(data)}`, "info");

          if (data.success) {
            resultDiv.innerHTML = `<div class="success">‚úÖ Login successful</div><pre>${JSON.stringify(
              data,
              null,
              2
            )}</pre>`;
            log("Login successful, enabling next tests", "success");
            document.getElementById("rawSessionBtn").disabled = false;
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå Login failed: ${data.message}</div>`;
            log(`Login failed: ${data.message}`, "error");
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Login error: ${error.message}</div>`;
          log(`Login error: ${error.message}`, "error");
        }
      }

      async function testRawSession() {
        log("Testing raw session check...", "info");
        const resultDiv = document.getElementById("rawSessionResult");

        try {
          log("Calling php/check_session.php directly", "info");

          const response = await fetch("../php/check_session.php", {
            method: "GET",
            credentials: "include",
          });

          const data = await response.json();
          log(`Raw session response: ${JSON.stringify(data)}`, "info");

          if (data.success && data.data && data.data.logged_in) {
            if (data.data.role === "donor") {
              resultDiv.innerHTML = `<div class="success">‚úÖ Session valid for donor</div><pre>${JSON.stringify(
                data,
                null,
                2
              )}</pre>`;
              log("Raw session check passed", "success");
              document.getElementById("mainJsBtn").disabled = false;
            } else {
              resultDiv.innerHTML = `<div class="warning">‚ö†Ô∏è Wrong role: ${
                data.data.role
              }</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
              log(`Wrong role in session: ${data.data.role}`, "error");
            }
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå No valid session</div><pre>${JSON.stringify(
              data,
              null,
              2
            )}</pre>`;
            log("No valid session found in raw check", "error");
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Raw session error: ${error.message}</div>`;
          log(`Raw session error: ${error.message}`, "error");
        }
      }

      async function testMainJsSession() {
        log("Testing main.js Session.checkSession()...", "info");
        const resultDiv = document.getElementById("mainJsResult");

        try {
          if (typeof Session === "undefined") {
            resultDiv.innerHTML = `<div class="error">‚ùå Session object undefined</div>`;
            log(
              "Session object is undefined - main.js not loaded properly",
              "error"
            );
            return;
          }

          log("Session object found, calling checkSession()", "info");

          const result = await Session.checkSession();
          log(
            `Session.checkSession() result: ${JSON.stringify(result)}`,
            "info"
          );

          if (result) {
            if (result.role === "donor") {
              resultDiv.innerHTML = `<div class="success">‚úÖ main.js session check passed</div><pre>${JSON.stringify(
                result,
                null,
                2
              )}</pre>`;
              log("main.js session check passed", "success");
              document.getElementById("dashboardAuthBtn").disabled = false;
            } else {
              resultDiv.innerHTML = `<div class="warning">‚ö†Ô∏è main.js wrong role: ${
                result.role
              }</div><pre>${JSON.stringify(result, null, 2)}</pre>`;
              log(`main.js session wrong role: ${result.role}`, "error");
            }
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå main.js session returned null</div>`;
            log("main.js Session.checkSession() returned null", "error");
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå main.js session error: ${error.message}</div>`;
          log(`main.js session error: ${error.message}`, "error");
        }
      }

      async function simulateDashboardAuth() {
        log("Simulating exact dashboard auth check...", "info");
        const resultDiv = document.getElementById("dashboardAuthResult");

        try {
          log("Starting dashboard auth simulation", "info");

          // This is the EXACT code from dashboard
          if (typeof Session === "undefined") {
            log("Session undefined in dashboard simulation", "error");
            resultDiv.innerHTML = `<div class="error">‚ùå Session undefined - would retry</div>`;
            return;
          }

          const user = await Session.checkSession();
          log(
            `Dashboard auth - Session.checkSession() returned: ${JSON.stringify(
              user
            )}`,
            "info"
          );

          if (!user || user.role !== "donor") {
            log(
              `Dashboard auth failed - user: ${JSON.stringify(user)}`,
              "error"
            );
            resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Dashboard auth would FAIL and REDIRECT<br>
                            User: ${JSON.stringify(user)}<br>
                            Expected role: "donor"<br>
                            Actual role: "${user ? user.role : "null"}"<br>
                            <strong>THIS IS WHY YOU'RE GETTING REDIRECTED</strong>
                        </div>
                    `;
          } else {
            log("Dashboard auth would succeed", "success");
            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Dashboard auth would SUCCEED<br>
                            User: ${user.full_name}<br>
                            Role: ${user.role}<br>
                            Dashboard should load normally
                        </div>
                    `;
          }
        } catch (error) {
          log(`Dashboard auth simulation error: ${error.message}`, "error");
          resultDiv.innerHTML = `<div class="error">‚ùå Dashboard auth error: ${error.message}</div>`;
        }
      }

      // Auto-start debug on page load
      log("Page loaded - ready for testing", "info");
    </script>
  </body>
</html>
