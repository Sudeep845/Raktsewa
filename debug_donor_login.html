<!DOCTYPE html>
<html>
  <head>
    <title>Donor Login Redirect Debug</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .step {
        background: white;
        margin: 15px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .success {
        border-left: 5px solid #28a745;
      }
      .error {
        border-left: 5px solid #dc3545;
      }
      .warning {
        border-left: 5px solid #ffc107;
      }
      .info {
        border-left: 5px solid #17a2b8;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
      .log {
        background: #f1f3f4;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Donor Login Redirect Debug</h1>
      <p>
        This tool will help identify exactly where the donor login process is
        failing.
      </p>

      <div class="step info">
        <h3>üéØ Test Overview</h3>
        <p>We'll test the complete donor login flow step by step:</p>
        <ol>
          <li>Login API call</li>
          <li>Session verification</li>
          <li>Dashboard role check</li>
          <li>Redirect simulation</li>
        </ol>
        <button onclick="runFullTest()">üöÄ Run Complete Test</button>
      </div>

      <div id="step1" class="step">
        <h3>Step 1: Login API Test</h3>
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResult"></div>
      </div>

      <div id="step2" class="step">
        <h3>Step 2: Session Check</h3>
        <button onclick="testSession()" disabled id="sessionBtn">
          Check Session
        </button>
        <div id="sessionResult"></div>
      </div>

      <div id="step3" class="step">
        <h3>Step 3: Role Verification</h3>
        <button onclick="testRoleCheck()" disabled id="roleBtn">
          Check Role Logic
        </button>
        <div id="roleResult"></div>
      </div>

      <div id="step4" class="step">
        <h3>Step 4: Dashboard Access</h3>
        <button onclick="testDashboard()" disabled id="dashboardBtn">
          Test Dashboard
        </button>
        <div id="dashboardResult"></div>
      </div>

      <div id="logs" class="step">
        <h3>üìä Debug Logs</h3>
        <div id="debugLogs" class="log">Ready to start testing...</div>
      </div>
    </div>

    <script>
      let sessionData = null;

      function log(message, type = "info") {
        const logsDiv = document.getElementById("debugLogs");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
        logsDiv.textContent += logEntry;
        logsDiv.scrollTop = logsDiv.scrollHeight;
        console.log(logEntry);
      }

      async function runFullTest() {
        log("Starting complete donor login test flow");
        await testLogin();
        await new Promise((resolve) => setTimeout(resolve, 1000));
        await testSession();
        await new Promise((resolve) => setTimeout(resolve, 1000));
        await testRoleCheck();
        await new Promise((resolve) => setTimeout(resolve, 1000));
        await testDashboard();
        log("Complete test flow finished");
      }

      async function testLogin() {
        log("Testing donor login API...");
        const resultDiv = document.getElementById("loginResult");
        const step = document.getElementById("step1");

        try {
          const formData = new FormData();
          formData.append("username", "donor1");
          formData.append("password", "password");
          formData.append("role", "donor");

          log("Sending login request with credentials: donor1/password/donor");

          const response = await fetch("php/login.php", {
            method: "POST",
            body: formData,
            credentials: "include", // Important for cookies/sessions
          });

          const data = await response.json();
          log(`Login response received: ${JSON.stringify(data)}`);

          if (data.success) {
            step.className = "step success";
            resultDiv.innerHTML = `
                        <p><strong>‚úÖ Login Successful!</strong></p>
                        <p>User: ${data.data.full_name} (${data.data.role})</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
            sessionData = data.data;
            document.getElementById("sessionBtn").disabled = false;
            log("Login successful, enabling next step");
          } else {
            step.className = "step error";
            resultDiv.innerHTML = `
                        <p><strong>‚ùå Login Failed!</strong></p>
                        <p>Error: ${data.message}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
            log(`Login failed: ${data.message}`);
          }
        } catch (error) {
          step.className = "step error";
          resultDiv.innerHTML = `<p><strong>‚ùå Error:</strong> ${error.message}</p>`;
          log(`Login error: ${error.message}`);
        }
      }

      async function testSession() {
        log("Testing session verification...");
        const resultDiv = document.getElementById("sessionResult");
        const step = document.getElementById("step2");

        try {
          const response = await fetch("php/check_session.php", {
            method: "GET",
            credentials: "include",
          });

          const data = await response.json();
          log(`Session response: ${JSON.stringify(data)}`);

          if (data.success && data.data && data.data.logged_in) {
            if (data.data.role === "donor") {
              step.className = "step success";
              resultDiv.innerHTML = `
                            <p><strong>‚úÖ Session Valid!</strong></p>
                            <p>Role: ${data.data.role} ‚úì</p>
                            <p>User: ${data.data.full_name}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
              sessionData = data.data;
              document.getElementById("roleBtn").disabled = false;
              log("Session is valid for donor role");
            } else {
              step.className = "step warning";
              resultDiv.innerHTML = `
                            <p><strong>‚ö†Ô∏è Role Mismatch!</strong></p>
                            <p>Expected: donor, Got: ${data.data.role}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
              log(`Role mismatch: expected donor, got ${data.data.role}`);
            }
          } else {
            step.className = "step error";
            resultDiv.innerHTML = `
                        <p><strong>‚ùå No Valid Session!</strong></p>
                        <p>This is why donors get redirected back to login</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
            log("No valid session found - this is the redirect cause");
          }
        } catch (error) {
          step.className = "step error";
          resultDiv.innerHTML = `<p><strong>‚ùå Error:</strong> ${error.message}</p>`;
          log(`Session check error: ${error.message}`);
        }
      }

      async function testRoleCheck() {
        log("Testing role check logic...");
        const resultDiv = document.getElementById("roleResult");
        const step = document.getElementById("step3");

        if (sessionData) {
          const userRole = sessionData.role;
          const expectedRole = "donor";
          const roleCheckPassed = userRole === expectedRole;

          if (roleCheckPassed) {
            step.className = "step success";
            resultDiv.innerHTML = `
                        <p><strong>‚úÖ Role Check Passed!</strong></p>
                        <p>User role "${userRole}" matches expected "${expectedRole}"</p>
                        <p>Dashboard should be accessible</p>
                    `;
            document.getElementById("dashboardBtn").disabled = false;
            log("Role check passed, dashboard should be accessible");
          } else {
            step.className = "step error";
            resultDiv.innerHTML = `
                        <p><strong>‚ùå Role Check Failed!</strong></p>
                        <p>User role "${userRole}" does not match expected "${expectedRole}"</p>
                        <p>This would cause a redirect to login</p>
                    `;
            log(`Role check failed: ${userRole} !== ${expectedRole}`);
          }
        } else {
          step.className = "step warning";
          resultDiv.innerHTML = `<p><strong>‚ö†Ô∏è No session data available</strong></p>`;
          log("No session data for role check");
        }
      }

      async function testDashboard() {
        log("Testing dashboard accessibility...");
        const resultDiv = document.getElementById("dashboardResult");
        const step = document.getElementById("step4");

        try {
          const response = await fetch("user/dashboard.html", {
            method: "HEAD",
            credentials: "include",
          });

          if (response.ok) {
            step.className = "step success";
            resultDiv.innerHTML = `
                        <p><strong>‚úÖ Dashboard Accessible!</strong></p>
                        <p>Status: ${response.status} ${response.statusText}</p>
                        <p><a href="user/dashboard.html" target="_blank">üéØ Open Donor Dashboard</a></p>
                        <p><strong>üéâ Complete login flow should work!</strong></p>
                    `;
            log("Dashboard is accessible - login flow complete");
          } else {
            step.className = "step error";
            resultDiv.innerHTML = `
                        <p><strong>‚ùå Dashboard Access Error!</strong></p>
                        <p>Status: ${response.status} ${response.statusText}</p>
                    `;
            log(`Dashboard access error: ${response.status}`);
          }
        } catch (error) {
          step.className = "step error";
          resultDiv.innerHTML = `<p><strong>‚ùå Error:</strong> ${error.message}</p>`;
          log(`Dashboard test error: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
