<!DOCTYPE html>
<html>
  <head>
    <title>Fixed Donor Login Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      .step {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
      }
      .error {
        background: #f8d7da;
      }
      button {
        padding: 10px 20px;
        margin: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>üîß Fixed Donor Login Test</h1>

    <div class="step">
      <h3>Test Complete Login Flow</h3>
      <p>This will:</p>
      <ol>
        <li>Login as donor1</li>
        <li>Verify session</li>
        <li>Redirect to dashboard (which should now work)</li>
      </ol>
      <button onclick="testCompleteFlow()">üöÄ Test Complete Flow</button>
      <div id="result"></div>
    </div>

    <div class="step">
      <h3>Manual Dashboard Test</h3>
      <p>Click below to go directly to the dashboard after logging in:</p>
      <button onclick="manualDashboardTest()" disabled id="dashboardBtn">
        üéØ Open Dashboard
      </button>
    </div>

    <script>
      async function testCompleteFlow() {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "<p>üîÑ Testing complete flow...</p>";

        try {
          // Step 1: Login
          const formData = new FormData();
          formData.append("username", "donor1");
          formData.append("password", "password");
          formData.append("role", "donor");

          const loginResponse = await fetch("php/login.php", {
            method: "POST",
            body: formData,
            credentials: "include",
          });

          const loginData = await loginResponse.json();

          if (loginData.success) {
            resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Step 1: Login Successful!</h4>
                            <p>User: ${loginData.data.full_name} (${loginData.data.role})</p>
                        </div>
                    `;

            // Step 2: Verify session
            setTimeout(async () => {
              try {
                const sessionResponse = await fetch("php/check_session.php", {
                  credentials: "include",
                });

                const sessionData = await sessionResponse.json();

                if (sessionData.success && sessionData.data.role === "donor") {
                  resultDiv.innerHTML += `
                                    <div class="success">
                                        <h4>‚úÖ Step 2: Session Verified!</h4>
                                        <p>Role: ${sessionData.data.role} ‚úì</p>
                                    </div>
                                `;

                  // Enable manual test button
                  document.getElementById("dashboardBtn").disabled = false;

                  // Step 3: Auto-redirect to dashboard
                  resultDiv.innerHTML += `
                                    <div class="success">
                                        <h4>üéØ Step 3: Redirecting to Dashboard...</h4>
                                        <p>You should see the dashboard load without redirect issues!</p>
                                    </div>
                                `;

                  setTimeout(() => {
                    window.location.href = "user/dashboard.html";
                  }, 2000);
                } else {
                  resultDiv.innerHTML += `
                                    <div class="error">
                                        <h4>‚ùå Step 2: Session Issue!</h4>
                                        <pre>${JSON.stringify(
                                          sessionData,
                                          null,
                                          2
                                        )}</pre>
                                    </div>
                                `;
                }
              } catch (error) {
                resultDiv.innerHTML += `
                                <div class="error">
                                    <h4>‚ùå Step 2: Session Check Error!</h4>
                                    <p>${error.message}</p>
                                </div>
                            `;
              }
            }, 500);
          } else {
            resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Step 1: Login Failed!</h4>
                            <p>${loginData.message}</p>
                        </div>
                    `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error!</h4>
                        <p>${error.message}</p>
                    </div>
                `;
        }
      }

      function manualDashboardTest() {
        window.location.href = "user/dashboard.html";
      }
    </script>
  </body>
</html>
