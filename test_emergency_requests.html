<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emergency Requests Test - HopeDrops</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/main.js"></script>

    <style>
      .test-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .emergency-stats {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
      }

      .badge-lg {
        font-size: 0.9em;
        padding: 0.4em 0.6em;
      }

      .emergency-request-row:hover {
        background-color: #f8f9fa;
      }

      .emergency-request-row[data-urgency="critical"] {
        border-left: 4px solid #dc3545;
      }

      .emergency-request-row[data-urgency="high"] {
        border-left: 4px solid #ffc107;
      }

      .contact-info {
        white-space: nowrap;
      }

      .test-header {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <div class="test-header">
        <h1><i class="fas fa-vial"></i> Emergency Requests System Test</h1>
        <p>
          Testing the dynamic Emergency Requests feature for RaktSewa Hospital
          Management
        </p>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-flask"></i> API Test Results</h5>
            </div>
            <div class="card-body">
              <div id="apiTestResults">
                <p class="text-muted">
                  Click "Test Emergency Requests API" to test the backend.
                </p>
              </div>
              <button class="btn btn-primary" onclick="testEmergencyAPI()">
                <i class="fas fa-play"></i> Test Emergency Requests API
              </button>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-chart-bar"></i> Quick Statistics</h5>
            </div>
            <div class="card-body">
              <div id="quickStats">
                <p class="text-muted">No data loaded yet.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between">
          <h5>
            <i class="fas fa-exclamation-triangle text-danger"></i> Emergency
            Blood Requests Demo
          </h5>
          <div>
            <button
              class="btn btn-sm btn-outline-primary"
              onclick="refreshEmergencyRequests()"
            >
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button
              class="btn btn-sm btn-danger"
              onclick="showEmergencyModal()"
            >
              <i class="fas fa-exclamation-triangle"></i> Open Emergency
              Requests
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-8">
              <div class="form-inline">
                <label class="mr-2">Filter by:</label>
                <select
                  class="form-control form-control-sm mr-2"
                  id="urgencyFilter"
                >
                  <option value="">All Urgency Levels</option>
                  <option value="critical">Critical</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
                <select
                  class="form-control form-control-sm mr-2"
                  id="bloodTypeFilter"
                >
                  <option value="">All Blood Types</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
                <button
                  class="btn btn-sm btn-primary"
                  onclick="applyEmergencyFilters()"
                >
                  <i class="fas fa-filter"></i> Apply Filters
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="emergency-stats">
                <small class="text-muted">Live Stats:</small>
                <div class="d-flex justify-content-between">
                  <span class="badge badge-danger"
                    >Critical: <span id="criticalCount">0</span></span
                  >
                  <span class="badge badge-warning"
                    >High: <span id="highCount">0</span></span
                  >
                  <span class="badge badge-info"
                    >Others: <span id="otherCount">0</span></span
                  >
                </div>
              </div>
            </div>
          </div>

          <div id="loadingIndicator" class="text-center" style="display: none">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2">Loading emergency requests...</p>
          </div>

          <div id="emergencyRequestsContent">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Click "Test Emergency Requests
              API" to load dynamic data.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let emergencyData = [];

      function testEmergencyAPI() {
        const resultsDiv = document.getElementById("apiTestResults");
        resultsDiv.innerHTML =
          '<p class="text-info"><i class="fas fa-spinner fa-spin"></i> Testing API...</p>';

        fetch("php/get_emergency_requests.php")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              resultsDiv.innerHTML = `
                            <div class="alert alert-success">
                                <strong><i class="fas fa-check"></i> API Test Successful!</strong>
                                <br>Retrieved ${data.data.length} emergency requests
                                <br><small>Message: ${data.message}</small>
                            </div>
                        `;

              // Update quick stats
              document.getElementById("quickStats").innerHTML = `
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-center">
                                        <h4 class="text-danger">${data.stats.critical_count}</h4>
                                        <small>Critical</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <h4 class="text-warning">${data.stats.high_count}</h4>
                                        <small>High Priority</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <small class="text-muted">Total: ${data.stats.total_requests} requests</small>
                        `;

              // Load the data into display
              emergencyData = data.data;
              displayEmergencyRequests(emergencyData);
              updateEmergencyStats(emergencyData);
            } else {
              resultsDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong><i class="fas fa-exclamation-triangle"></i> API Test Failed</strong>
                                <br>Error: ${data.message || "Unknown error"}
                            </div>
                        `;
            }
          })
          .catch((error) => {
            console.error("API test error:", error);
            resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong><i class="fas fa-times"></i> Connection Error</strong>
                            <br>Could not connect to API: ${error.message}
                        </div>
                    `;
          });
      }

      function displayEmergencyRequests(requests) {
        const content = document.getElementById("emergencyRequestsContent");

        if (!requests || requests.length === 0) {
          content.innerHTML =
            '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No emergency requests found.</div>';
          return;
        }

        // Sort by urgency priority
        const urgencyOrder = { critical: 0, high: 1, medium: 2, low: 3 };
        requests.sort(
          (a, b) => urgencyOrder[a.urgency] - urgencyOrder[b.urgency]
        );

        content.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th><i class="fas fa-user-injured"></i> Patient</th>
                                <th><i class="fas fa-tint"></i> Blood Type</th>
                                <th><i class="fas fa-vials"></i> Units</th>
                                <th><i class="fas fa-exclamation-triangle"></i> Urgency</th>
                                <th><i class="fas fa-clock"></i> Time</th>
                                <th><i class="fas fa-hospital"></i> Hospital</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests
                              .map(
                                (request) => `
                                <tr class="emergency-request-row" data-urgency="${
                                  request.urgency
                                }" data-blood-type="${request.blood_type}">
                                    <td>
                                        <strong>${
                                          request.patient_name || "Anonymous"
                                        }</strong>
                                        <br><small class="text-muted">${
                                          request.notes
                                        }</small>
                                    </td>
                                    <td>
                                        <span class="badge badge-danger badge-lg">${
                                          request.blood_type
                                        }</span>
                                    </td>
                                    <td>
                                        <strong>${
                                          request.units_needed
                                        }</strong> units
                                    </td>
                                    <td>
                                        <span class="badge badge-${getUrgencyBadgeClass(
                                          request.urgency
                                        )}">
                                            ${getUrgencyIcon(
                                              request.urgency
                                            )} ${request.urgency.toUpperCase()}
                                        </span>
                                    </td>
                                    <td>
                                        <small>${formatRequestTime(
                                          request.created_at
                                        )}</small>
                                    </td>
                                    <td>
                                        <strong>${
                                          request.hospital_name
                                        }</strong>
                                        <br><small class="text-muted">
                                            <i class="fas fa-phone"></i> ${
                                              request.contact_phone || "N/A"
                                            }
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-success btn-sm" onclick="respondToRequest(${
                                              request.id
                                            }, 'available')" title="Available">
                                                <i class="fas fa-check"></i> Available
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="respondToRequest(${
                                              request.id
                                            }, 'partial')" title="Partial">
                                                <i class="fas fa-exclamation"></i> Partial
                                            </button>
                                            <button class="btn btn-secondary btn-sm" onclick="respondToRequest(${
                                              request.id
                                            }, 'unavailable')" title="Unavailable">
                                                <i class="fas fa-times"></i> No
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;
      }

      function updateEmergencyStats(requests) {
        const criticalCount = requests.filter(
          (r) => r.urgency === "critical"
        ).length;
        const highCount = requests.filter((r) => r.urgency === "high").length;
        const otherCount = requests.filter(
          (r) => r.urgency !== "critical" && r.urgency !== "high"
        ).length;

        document.getElementById("criticalCount").textContent = criticalCount;
        document.getElementById("highCount").textContent = highCount;
        document.getElementById("otherCount").textContent = otherCount;
      }

      function getUrgencyBadgeClass(urgency) {
        const classes = {
          critical: "danger",
          high: "warning",
          medium: "info",
          low: "secondary",
        };
        return classes[urgency] || "secondary";
      }

      function getUrgencyIcon(urgency) {
        const icons = {
          critical: '<i class="fas fa-skull-crossbones"></i>',
          high: '<i class="fas fa-exclamation-triangle"></i>',
          medium: '<i class="fas fa-exclamation-circle"></i>',
          low: '<i class="fas fa-info-circle"></i>',
        };
        return icons[urgency] || '<i class="fas fa-question-circle"></i>';
      }

      function formatRequestTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / (1000 * 60));

        if (diffMinutes < 1) return "Just now";
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
        return date.toLocaleDateString();
      }

      function respondToRequest(requestId, status) {
        const statusMessages = {
          available: "Blood is available for immediate pickup",
          partial: "Some units available, please contact us",
          unavailable: "No blood available at this time",
        };

        Swal.fire({
          title: "Respond to Emergency Request",
          html: `Are you sure you want to respond as: <strong>${status.toUpperCase()}</strong>?<br><small>${
            statusMessages[status]
          }</small>`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Send Response",
          cancelButtonText: "Cancel",
        }).then((result) => {
          if (result.isConfirmed) {
            // Simulate API call
            Swal.fire({
              title: "Response Sent!",
              text: "Your response has been sent to the requesting hospital.",
              icon: "success",
              timer: 2000,
            });
          }
        });
      }

      function refreshEmergencyRequests() {
        testEmergencyAPI();
      }

      function applyEmergencyFilters() {
        const urgencyFilter = document.getElementById("urgencyFilter").value;
        const bloodTypeFilter =
          document.getElementById("bloodTypeFilter").value;
        const rows = document.querySelectorAll(".emergency-request-row");

        rows.forEach((row) => {
          const urgency = row.dataset.urgency;
          const bloodType = row.dataset.bloodType;

          const urgencyMatch = !urgencyFilter || urgency === urgencyFilter;
          const bloodTypeMatch =
            !bloodTypeFilter || bloodType === bloodTypeFilter;

          row.style.display = urgencyMatch && bloodTypeMatch ? "" : "none";
        });
      }

      function showEmergencyModal() {
        Swal.fire({
          title: "Feature Demo",
          text: "This would open the full Emergency Requests modal in the actual hospital pages.",
          icon: "info",
        });
      }

      // Auto-load data on page load
      document.addEventListener("DOMContentLoaded", function () {
        testEmergencyAPI();
      });
    </script>
  </body>
</html>
