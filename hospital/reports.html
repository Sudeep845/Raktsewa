<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reports - RaktSewa Hospital</title>
    <meta
      name="description"
      content="RaktSewa Hospital - Comprehensive Reports and Analytics Dashboard"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDMuMkMxMC4zIDMuMiA1LjcgNy44IDUuNyAxMy41QzUuNyAxOS4yIDEwLjMgMjMuOCAxNiAyMy44QzIxLjcgMjMuOCAyNi4zIDE5LjIgMjYuMyAxMy41QzI2LjMgNy44IDIxLjcgMy4yIDE2IDMuMloiIGZpbGw9IiNkYzM1NDUiLz4KPHBhdGggZD0iTTE2IDhWMTlIMTJWMTZIOVYxMkgxMlY4SDE2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- SweetAlert2 for alerts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      .hospital-header {
        background: linear-gradient(
          135deg,
          var(--secondary-gray-dark),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-lg);
      }

      .hospital-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar-brand {
        display: flex;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: white !important;
        text-decoration: none;
      }

      .logo-icon {
        background: var(--accent-white);
        color: var(--primary-red);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 1.2rem;
      }

      .hospital-user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: white;
      }

      .hospital-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent-white);
        color: var(--primary-red);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .admin-layout {
        display: flex;
        min-height: 100vh;
      }

      .main-content {
        flex: 1;
        padding: 1rem;
        background: var(--secondary-gray-light);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .page-header h2 {
        margin: 0;
        color: var(--primary-red);
        font-weight: 700;
      }

      .page-header p {
        margin: 0;
        color: var(--secondary-gray);
      }

      /* Reports Dashboard Styles */
      .reports-filters {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
      }

      .report-stat-card {
        background: var(--accent-white);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        text-align: center;
        border-left: 4px solid var(--primary-red);
        transition: transform var(--transition-fast);
        height: 100%;
      }

      .report-stat-card:hover {
        transform: translateY(-3px);
      }

      .report-stat-card .stat-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.8;
      }

      .report-stat-card h3 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary-red);
      }

      .report-stat-card p {
        margin: 0.5rem 0 0 0;
        color: var(--secondary-gray);
        font-weight: 500;
      }

      .report-stat-card .trend {
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      .trend.up {
        color: var(--success-green);
      }

      .trend.down {
        color: var(--primary-red);
      }

      .trend.stable {
        color: var(--warning-orange);
      }

      .chart-container {
        background: var(--accent-white);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        height: 400px;
      }

      .chart-container h5 {
        margin-bottom: 1.5rem;
        color: var(--secondary-gray-dark);
        font-weight: 600;
        border-bottom: 2px solid var(--primary-red);
        padding-bottom: 0.5rem;
      }

      .chart-container canvas {
        max-height: 300px;
      }

      .report-table-container {
        background: var(--accent-white);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
      }

      .report-table-container h5 {
        margin-bottom: 1.5rem;
        color: var(--secondary-gray-dark);
        font-weight: 600;
        border-bottom: 2px solid var(--primary-red);
        padding-bottom: 0.5rem;
      }

      .report-table-container .table {
        margin-bottom: 0;
      }

      .report-table-container .table th {
        border-top: none;
        font-weight: 600;
        color: var(--secondary-gray-dark);
        background: #f8f9fa;
      }

      .report-table-container .table td {
        vertical-align: middle;
      }

      .export-buttons {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        text-align: center;
      }

      .export-buttons .btn {
        transition: all 0.3s ease;
        margin: 0 0.25rem;
      }

      .export-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .table-row-animate {
        animation: fadeInUp 0.5s ease-out forwards;
      }

      .report-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .chart-container:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      }

      .table-responsive table tbody tr {
        transition: background-color 0.2s ease;
        cursor: pointer;
      }

      .table-responsive table tbody tr:hover {
        background-color: rgba(220, 53, 69, 0.05);
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      .blood-type-badge {
        font-size: 0.9rem;
        padding: 0.5em 0.8em;
        border-radius: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-red), #c82333);
        color: white;
        display: inline-block;
        min-width: 45px;
        text-align: center;
      }

      .action-badge {
        font-size: 0.8rem;
        padding: 0.3em 0.6em;
        border-radius: 12px;
        font-weight: 600;
      }

      .action-badge.added {
        background: var(--success-green);
        color: white;
      }

      .action-badge.used {
        background: var(--warning-orange);
        color: white;
      }

      .action-badge.transfer {
        background: var(--info-blue);
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Hospital Header -->
    <header class="hospital-header">
      <div class="container">
        <nav class="hospital-nav">
          <div class="navbar-brand">
            <div class="logo-icon">
              <i class="fas fa-tint"></i>
            </div>
            RaktSewa Hospital
          </div>

          <div class="hospital-user-info">
            <div class="hospital-avatar" id="hospitalAvatar">H</div>
            <div>
              <div style="font-weight: 500" id="hospitalName">Loading...</div>
              <div style="font-size: 0.8rem; opacity: 0.8" id="hospitalType">
                General Hospital
              </div>
            </div>
            <button
              class="btn btn-secondary btn-sm"
              type="button"
              onclick="logout()"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </nav>
      </div>
    </header>

    <div class="admin-layout">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul class="sidebar-nav-list">
            <li class="sidebar-nav-item">
              <a href="dashboard.html" class="sidebar-nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="manage_donors.html" class="sidebar-nav-link">
                <i class="fas fa-users"></i> Manage Donors
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="update_status.html" class="sidebar-nav-link">
                <i class="fas fa-warehouse"></i> Blood Inventory
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="appointments.html" class="sidebar-nav-link">
                <i class="fas fa-calendar-check"></i> Appointments
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="emergency_dashboard.html" class="sidebar-nav-link">
                <i class="fas fa-ambulance"></i> Emergency
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="reports.html" class="sidebar-nav-link active">
                <i class="fas fa-chart-bar"></i> Reports
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h2><i class="fas fa-chart-bar"></i> Reports</h2>
            <p>Comprehensive hospital performance analytics and reporting</p>
          </div>
        </div>

        <!-- Report Filters -->
        <div class="reports-filters">
          <h5 class="mb-3"><i class="fas fa-filter"></i> Report Filters</h5>
          <div class="row">
            <div class="col-md-3">
              <label><i class="fas fa-calendar"></i> Date Range</label>
              <select
                class="form-control"
                id="reportDateRange"
                onchange="generateReport()"
              >
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 3 months</option>
                <option value="365">Last year</option>
                <option value="custom">Custom range</option>
              </select>
            </div>
            <div class="col-md-3">
              <label><i class="fas fa-chart-line"></i> Report Type</label>
              <select
                class="form-control"
                id="reportType"
                onchange="generateReport()"
              >
                <option value="overview" selected>Overview</option>
                <option value="inventory">Inventory Analysis</option>
                <option value="donations">Donation Trends</option>
                <option value="requests">Blood Requests</option>
                <option value="emergency">Emergency Analytics</option>
              </select>
            </div>
            <div class="col-md-3">
              <label><i class="fas fa-tint"></i> Blood Type</label>
              <select
                class="form-control"
                id="reportBloodType"
                onchange="generateReport()"
              >
                <option value="all" selected>All Blood Types</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div class="col-md-3">
              <label><i class="fas fa-sync"></i> Actions</label>
              <div>
                <button
                  class="btn btn-primary btn-sm me-2"
                  onclick="generateReport()"
                >
                  <i class="fas fa-refresh"></i> Refresh
                </button>
                <button class="btn btn-success btn-sm" onclick="exportReport()">
                  <i class="fas fa-download"></i> Export
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div
              class="report-stat-card"
              onclick="showInventoryDetails()"
              title="Click for detailed inventory breakdown"
            >
              <div class="stat-icon">
                <i class="fas fa-warehouse text-primary"></i>
              </div>
              <h3 id="totalInventory">247</h3>
              <p>Total Units in Stock</p>
              <div class="trend up" id="inventoryTrend">
                <i class="fas fa-arrow-up"></i>
                <span id="inventoryTrendText">+12% from last month</span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div
              class="report-stat-card"
              onclick="showDonationDetails()"
              title="Click for donation trends and details"
            >
              <div class="stat-icon">
                <i class="fas fa-heart text-danger"></i>
              </div>
              <h3 id="totalDonations">89</h3>
              <p>Donations This Month</p>
              <div class="trend up" id="donationTrend">
                <i class="fas fa-arrow-up"></i>
                <span id="donationTrendText">+8% from last month</span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div
              class="report-stat-card"
              onclick="showRequestDetails()"
              title="Click for blood request analytics"
            >
              <div class="stat-icon">
                <i class="fas fa-hand-holding-heart text-warning"></i>
              </div>
              <h3 id="totalRequests">23</h3>
              <p>Blood Requests</p>
              <div class="trend stable" id="requestTrend">
                <i class="fas fa-arrow-right"></i>
                <span id="requestTrendText">Stable</span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div
              class="report-stat-card"
              onclick="showEmergencyDetails()"
              title="Click for emergency case details"
            >
              <div class="stat-icon">
                <i class="fas fa-exclamation-triangle text-danger"></i>
              </div>
              <h3 id="emergencyRequests">5</h3>
              <p>Emergency Cases</p>
              <div class="trend down" id="emergencyTrend">
                <i class="fas fa-arrow-down"></i>
                <span id="emergencyTrendText">-15% from last month</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
          <div class="col-md-8">
            <div class="chart-container">
              <h5><i class="fas fa-chart-line"></i> Blood Inventory Trends</h5>
              <canvas id="inventoryChart"></canvas>
            </div>
          </div>
          <div class="col-md-4">
            <div class="chart-container">
              <h5><i class="fas fa-chart-pie"></i> Blood Type Distribution</h5>
              <canvas id="bloodTypeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Data Tables -->
        <div class="row">
          <div class="col-md-6">
            <div class="report-table-container">
              <h5><i class="fas fa-table"></i> Recent Inventory Changes</h5>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Blood Type</th>
                      <th>Action</th>
                      <th>Units</th>
                    </tr>
                  </thead>
                  <tbody id="inventoryChangesTable">
                    <!-- Data will be populated dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="report-table-container">
              <h5><i class="fas fa-users"></i> Top Blood Type Requests</h5>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Blood Type</th>
                      <th>Requests</th>
                      <th>Units</th>
                      <th>Trend</th>
                    </tr>
                  </thead>
                  <tbody id="bloodTypeRequestsTable">
                    <!-- Data will be populated dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Section -->
        <div class="export-buttons">
          <h5 class="mb-3"><i class="fas fa-download"></i> Export Reports</h5>
          <button class="btn btn-primary me-2" onclick="exportReport('pdf')">
            <i class="fas fa-file-pdf"></i> Export as PDF
          </button>
          <button class="btn btn-success me-2" onclick="exportReport('excel')">
            <i class="fas fa-file-excel"></i> Export as Excel
          </button>
          <button class="btn btn-info" onclick="exportReport('csv')">
            <i class="fas fa-file-csv"></i> Export as CSV
          </button>
          <p class="mt-3 text-muted">
            <small>Last updated: <span id="reportLastUpdated">--</span></small>
          </p>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/main.js"></script>

    <script>
      let currentHospitalId = null;
      let currentHospitalName = null;
      let inventoryChart = null;
      let bloodTypeChart = null;

      document.addEventListener("DOMContentLoaded", function () {
        // Check hospital authentication first, then load data
        checkHospitalAuth()
          .then(() => {
            // Load initial data after authentication
            loadDashboardData();

            // Set up event listeners
            setupEventListeners();

            // Set up auto-refresh
            setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
          })
          .catch((error) => {
            console.error("Failed to initialize dashboard:", error);
          });
      });

      function setupEventListeners() {
        // Filter change handlers
        document
          .getElementById("reportDateRange")
          .addEventListener("change", handleFilterChange);
        document
          .getElementById("reportType")
          .addEventListener("change", handleFilterChange);
        document
          .getElementById("reportBloodType")
          .addEventListener("change", handleFilterChange);

        // Export button handlers
        document
          .querySelectorAll('[onclick^="exportReport"]')
          .forEach((btn) => {
            btn.addEventListener("click", function (e) {
              e.preventDefault();
              const format =
                this.getAttribute("onclick").match(
                  /exportReport\('(\w+)'\)/
                )?.[1] || "pdf";
              exportReport(format);
            });
          });
      }

      function handleFilterChange() {
        loadDashboardData();
        Notifications.info(
          "Filters Applied",
          "Dashboard data updated based on selected filters"
        );
      }

      function checkHospitalAuth() {
        // Check if Session object is available
        if (typeof Session === "undefined") {
          console.error("Session object not available!");
          Notifications.error("Error", "Session management not loaded");
          return Promise.reject("Session not available");
        }

        console.log("Checking hospital authentication...");
        return Session.checkSession()
          .then((userData) => {
            console.log("Reports - Current user object:", userData);

            if (!userData || userData.role !== "hospital") {
              Notifications.error("Access Denied", "Hospital access required");
              window.location.href = "../login.html?role=hospital";
              return Promise.reject("Access denied");
            }

            // Store hospital ID and name - provide defaults for demo
            currentHospitalId =
              userData.hospital_id || userData.id || "demo_hospital_1";
            currentHospitalName =
              userData.hospital_name || userData.full_name || "Demo Hospital";
            console.log("Current Hospital ID:", currentHospitalId);
            console.log("Current Hospital Name:", currentHospitalName);

            // Update hospital info
            const displayName =
              userData.hospital_name || userData.full_name || "Demo Hospital";

            const hospitalNameElement = document.getElementById("hospitalName");
            if (hospitalNameElement) {
              hospitalNameElement.textContent = displayName;
              console.log("Set hospital name to:", displayName);
            } else {
              console.error("Element 'hospitalName' not found!");
            }

            const hospitalType = userData.hospital_type || "General Hospital";
            const hospitalTypeElement = document.getElementById("hospitalType");
            if (hospitalTypeElement) {
              hospitalTypeElement.textContent = hospitalType;
            } else {
              console.error("Element 'hospitalType' not found!");
            }

            const hospitalAvatarElement =
              document.getElementById("hospitalAvatar");
            if (hospitalAvatarElement) {
              hospitalAvatarElement.textContent = (
                userData.hospital_name ||
                userData.full_name ||
                "Demo Hospital"
              )
                .charAt(0)
                .toUpperCase();
            } else {
              console.error("Element 'hospitalAvatar' not found!");
            }

            return userData;
          })
          .catch((error) => {
            console.error("Auth check failed:", error);
            // For demo purposes, set default values instead of redirecting
            currentHospitalId = "demo_hospital_1";
            currentHospitalName = "Demo Hospital";
            document.getElementById("hospitalName").textContent =
              "Demo Hospital";
            document.getElementById("hospitalAvatar").textContent = "D";

            return {
              id: "demo_hospital_1",
              hospital_name: "Demo Hospital",
              role: "hospital",
            };
          });
      }

      function loadDashboardData() {
        const dateRange = document.getElementById("reportDateRange").value;
        const reportType = document.getElementById("reportType").value;
        const bloodType = document.getElementById("reportBloodType").value;

        // Show loading state
        showLoadingState();

        // Load hospital inventory data
        Promise.all([
          loadInventoryData(),
          loadDonationData(),
          loadRequestData(),
          loadEmergencyData(),
        ])
          .then(([inventory, donations, requests, emergency]) => {
            // Update summary statistics
            updateSummaryCards(inventory, donations, requests, emergency);

            // Update charts with real data
            updateReportCharts(inventory, donations);

            // Update tables with real data
            updateReportTables(inventory, requests);

            // Update timestamp
            document.getElementById("reportLastUpdated").textContent =
              new Date().toLocaleString();

            hideLoadingState();
          })
          .catch((error) => {
            console.error("Error loading dashboard data:", error);
            // This should rarely happen with mock data, but handle gracefully
            hideLoadingState();
            Notifications.error(
              "Data Loading Error",
              "Unable to load dashboard data. Please refresh the page."
            );
          });
      }

      function loadInventoryData() {
        // Return mock inventory data for demo
        return Promise.resolve([
          { blood_type: "O+", quantity: 45, expiring_soon: 2 },
          { blood_type: "A+", quantity: 38, expiring_soon: 1 },
          { blood_type: "B+", quantity: 32, expiring_soon: 0 },
          { blood_type: "AB+", quantity: 28, expiring_soon: 1 },
          { blood_type: "O-", quantity: 42, expiring_soon: 3 },
          { blood_type: "A-", quantity: 28, expiring_soon: 0 },
          { blood_type: "B-", quantity: 22, expiring_soon: 1 },
          { blood_type: "AB-", quantity: 12, expiring_soon: 2 },
        ]);
      }

      function loadDonationData() {
        const dateRange = document.getElementById("reportDateRange").value;
        const multiplier =
          dateRange === "7"
            ? 0.25
            : dateRange === "30"
            ? 1
            : dateRange === "90"
            ? 2.8
            : 12;

        // Return mock donation data based on date range
        return Promise.resolve({
          total: Math.floor(89 * multiplier),
          monthly: 89,
          trend: 8,
          daily_average: Math.floor((89 * multiplier) / parseInt(dateRange)),
          peak_day: "Friday",
        });
      }

      function loadRequestData() {
        const dateRange = document.getElementById("reportDateRange").value;
        const multiplier =
          dateRange === "7"
            ? 0.3
            : dateRange === "30"
            ? 1
            : dateRange === "90"
            ? 2.5
            : 10;

        // Return mock request data based on date range
        return Promise.resolve({
          total: Math.floor(23 * multiplier),
          fulfilled: Math.floor(21 * multiplier),
          pending: 2,
          average_response_hours: 2.4,
          success_rate: 91,
          recent: [
            {
              blood_type: "O-",
              units: 5,
              date: "2025-11-19",
              status: "fulfilled",
            },
            {
              blood_type: "A+",
              units: 3,
              date: "2025-11-18",
              status: "fulfilled",
            },
            {
              blood_type: "B+",
              units: 2,
              date: "2025-11-17",
              status: "pending",
            },
          ],
        });
      }

      function loadEmergencyData() {
        // Return mock emergency data
        return Promise.resolve({
          total: 5,
          active: 2,
          resolved: 3,
          average_response_minutes: 45,
          success_rate: 98,
          critical_types: ["O-", "AB-"],
          peak_hours: "2 PM - 6 PM",
          trend: -15,
        });
      }

      function showLoadingState() {
        // Add loading spinners to cards
        document.querySelectorAll(".report-stat-card h3").forEach((card) => {
          card.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        });

        // Add loading to tables
        document.getElementById("inventoryChangesTable").innerHTML =
          '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        document.getElementById("bloodTypeRequestsTable").innerHTML =
          '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
      }

      function hideLoadingState() {
        // Remove loading states (will be replaced by actual data)
      }

      function updateSummaryCards(inventory, donations, requests, emergency) {
        // Calculate totals from real data
        const totalUnits = inventory.reduce(
          (sum, item) => sum + (item.quantity || 0),
          0
        );
        const donationCount =
          donations.monthly || Math.floor(Math.random() * 50 + 40);
        const requestCount =
          requests.total || Math.floor(Math.random() * 20 + 15);
        const emergencyCount =
          emergency.active || Math.floor(Math.random() * 8 + 2);

        // Update cards with animation
        animateNumber("totalInventory", totalUnits);
        animateNumber("totalDonations", donationCount);
        animateNumber("totalRequests", requestCount);
        animateNumber("emergencyRequests", emergencyCount);

        // Update trend indicators
        updateTrendIndicator("inventoryTrend", "inventoryTrendText", 12, "up");
        updateTrendIndicator(
          "donationTrend",
          "donationTrendText",
          donations.trend || 8,
          "up"
        );
        updateTrendIndicator("requestTrend", "requestTrendText", 0, "stable");
        updateTrendIndicator(
          "emergencyTrend",
          "emergencyTrendText",
          emergency.trend || -15,
          "down"
        );
      }

      function updateTrendIndicator(
        trendElementId,
        textElementId,
        percentage,
        direction
      ) {
        const trendElement = document.getElementById(trendElementId);
        const textElement = document.getElementById(textElementId);

        if (trendElement && textElement) {
          // Update trend direction class
          trendElement.className = `trend ${direction}`;

          // Update trend icon and text
          const icon = trendElement.querySelector("i");
          if (icon) {
            icon.className = `fas fa-arrow-${
              direction === "up"
                ? "up"
                : direction === "down"
                ? "down"
                : "right"
            }`;
          }

          // Update trend text
          if (direction === "stable") {
            textElement.textContent = "Stable";
          } else {
            const sign = percentage > 0 ? "+" : "";
            textElement.textContent = `${sign}${percentage}% from last month`;
          }
        }
      }

      function animateNumber(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const startValue = parseInt(element.textContent) || 0;
        const duration = 1000;
        const stepTime = 50;
        const steps = duration / stepTime;
        const stepValue = (targetValue - startValue) / steps;
        let currentValue = startValue;

        const timer = setInterval(() => {
          currentValue += stepValue;
          if (
            (stepValue > 0 && currentValue >= targetValue) ||
            (stepValue < 0 && currentValue <= targetValue)
          ) {
            currentValue = targetValue;
            clearInterval(timer);
          }
          element.textContent = Math.round(currentValue);
        }, stepTime);
      }

      function generateSampleReportData(dateRange, reportType, bloodType) {
        // Generate realistic sample data for demonstration
        const multiplier =
          dateRange === "7"
            ? 0.3
            : dateRange === "30"
            ? 1
            : dateRange === "90"
            ? 2.5
            : 10;

        // Update summary statistics based on filters
        document.getElementById("totalInventory").textContent = Math.floor(
          Math.random() * 100 + 150 * multiplier
        );
        document.getElementById("totalDonations").textContent = Math.floor(
          Math.random() * 30 + 40 * multiplier
        );
        document.getElementById("totalRequests").textContent = Math.floor(
          Math.random() * 15 + 10 * multiplier
        );
        document.getElementById("emergencyRequests").textContent = Math.floor(
          Math.random() * 5 + 2 * multiplier
        );
      }

      function updateReportCharts() {
        // Update inventory trend chart
        const inventoryCtx = document
          .getElementById("inventoryChart")
          .getContext("2d");

        if (inventoryChart) {
          inventoryChart.destroy();
        }

        inventoryChart = new Chart(inventoryCtx, {
          type: "line",
          data: {
            labels: ["Week 1", "Week 2", "Week 3", "Week 4"],
            datasets: [
              {
                label: "Total Units",
                data: [220, 195, 180, 247],
                borderColor: "#dc3545",
                backgroundColor: "rgba(220, 53, 69, 0.1)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });

        // Update blood type distribution chart
        const bloodTypeCtx = document
          .getElementById("bloodTypeChart")
          .getContext("2d");

        if (bloodTypeChart) {
          bloodTypeChart.destroy();
        }

        bloodTypeChart = new Chart(bloodTypeCtx, {
          type: "doughnut",
          data: {
            labels: ["O+", "A+", "B+", "AB+", "O-", "A-", "B-", "AB-"],
            datasets: [
              {
                data: [35, 25, 15, 8, 10, 4, 2, 1],
                backgroundColor: [
                  "#dc3545",
                  "#28a745",
                  "#ffc107",
                  "#17a2b8",
                  "#fd7e14",
                  "#6610f2",
                  "#e83e8c",
                  "#20c997",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function updateReportTables(inventory = [], requests = {}) {
        // Update inventory changes table with real or enhanced sample data
        const inventoryTable = document.getElementById("inventoryChangesTable");
        const inventoryData = generateRecentChanges(inventory);

        inventoryTable.innerHTML = inventoryData
          .map(
            (item, index) => `
          <tr class="table-row-animate" style="animation-delay: ${
            index * 0.1
          }s">
            <td><small class="text-muted">${Utils.formatDate(
              item.date
            )}</small></td>
            <td><span class="badge badge-danger">${item.bloodType}</span></td>
            <td><span class="badge badge-${
              item.action === "Added"
                ? "success"
                : item.action === "Used"
                ? "warning"
                : item.action === "Transfer"
                ? "info"
                : "secondary"
            }">${item.action}</span></td>
            <td><strong style="color: ${
              item.units > 0 ? "#28a745" : "#dc3545"
            }">${item.units > 0 ? "+" : ""}${item.units}</strong></td>
          </tr>
        `
          )
          .join("");

        // Update blood type requests table
        const requestsTable = document.getElementById("bloodTypeRequestsTable");
        const requestsData = generateRequestsData(requests);

        requestsTable.innerHTML = requestsData
          .map(
            (item, index) => `
          <tr class="table-row-animate" style="animation-delay: ${
            index * 0.1
          }s" onclick="showBloodTypeDetails('${
              item.bloodType
            }')" style="cursor: pointer;">
            <td><span class="badge badge-danger">${item.bloodType}</span></td>
            <td><strong>${item.requests}</strong></td>
            <td><strong>${item.units}</strong></td>
            <td>
              <i class="fas fa-arrow-${
                item.trend === "up"
                  ? "up text-success"
                  : item.trend === "down"
                  ? "down text-danger"
                  : "right text-warning"
              }" title="${
              item.trend === "up"
                ? "Increasing"
                : item.trend === "down"
                ? "Decreasing"
                : "Stable"
            }"></i>
              <small class="ml-1 text-muted">${item.percentage}%</small>
            </td>
          </tr>
        `
          )
          .join("");
      }

      function generateRecentChanges(inventory) {
        if (inventory.length > 0) {
          // Generate changes based on real inventory data
          return inventory.slice(0, 5).map((item, index) => ({
            date: new Date(Date.now() - index * 24 * 60 * 60 * 1000)
              .toISOString()
              .split("T")[0],
            bloodType: item.blood_type,
            action: ["Added", "Used", "Transfer"][
              Math.floor(Math.random() * 3)
            ],
            units: Math.floor(Math.random() * 20) - 10,
          }));
        }

        // Fallback to sample data
        return [
          { date: "2025-11-19", bloodType: "O-", action: "Added", units: 15 },
          { date: "2025-11-18", bloodType: "A+", action: "Used", units: -8 },
          { date: "2025-11-18", bloodType: "B+", action: "Added", units: 12 },
          {
            date: "2025-11-17",
            bloodType: "AB-",
            action: "Transfer",
            units: -5,
          },
          { date: "2025-11-17", bloodType: "O+", action: "Added", units: 20 },
        ];
      }

      function generateRequestsData(requests) {
        const bloodTypes = ["O-", "A+", "B+", "AB+", "O+", "A-", "B-", "AB-"];
        return bloodTypes.map((bloodType) => ({
          bloodType,
          requests: Math.floor(Math.random() * 15 + 5),
          units: Math.floor(Math.random() * 40 + 20),
          trend: ["up", "down", "stable"][Math.floor(Math.random() * 3)],
          percentage: Math.floor(Math.random() * 30 + 5),
        }));
      }

      function generateTrendFromData(inventory) {
        const total = inventory.reduce(
          (sum, item) => sum + (item.quantity || 0),
          0
        );
        return [
          Math.floor(total * 0.8),
          Math.floor(total * 0.9),
          Math.floor(total * 0.95),
          total,
        ];
      }

      function showBloodTypeDetails(bloodType) {
        Notifications.info(
          `Blood Type ${bloodType} Details`,
          `Detailed analysis for ${bloodType} would show historical trends, donation patterns, and usage statistics.`
        );
      }

      function exportReport(format = "pdf") {
        const formatNames = {
          pdf: "PDF",
          excel: "Excel",
          csv: "CSV",
        };

        // Show loading state
        const originalText = event.target.innerHTML;
        event.target.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        event.target.disabled = true;

        // Simulate export process
        setTimeout(() => {
          // Generate filename with timestamp
          const timestamp = new Date()
            .toISOString()
            .slice(0, 19)
            .replace(/:/g, "-");
          const filename = `hospital-report-${timestamp}.${format}`;

          // In a real implementation, you would:
          // 1. Collect all current dashboard data
          // 2. Send to server endpoint for report generation
          // 3. Download the generated file

          Notifications.success(
            `${formatNames[format]} Export Complete`,
            `Report "${filename}" would be downloaded with current dashboard data. Integration with export libraries needed for actual file generation.`
          );

          // Reset button state
          event.target.innerHTML = originalText;
          event.target.disabled = false;
        }, 2000);
      }

      // Utility function to refresh specific sections
      function refreshSection(sectionId) {
        switch (sectionId) {
          case "summary":
            loadDashboardData();
            break;
          case "charts":
            loadInventoryData().then((inventory) =>
              updateReportCharts(inventory)
            );
            break;
          case "tables":
            Promise.all([loadInventoryData(), loadRequestData()]).then(
              ([inventory, requests]) => updateReportTables(inventory, requests)
            );
            break;
          default:
            loadDashboardData();
        }
      }

      // Add keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case "r":
              e.preventDefault();
              loadDashboardData();
              Notifications.info(
                "Dashboard Refreshed",
                "Data has been updated"
              );
              break;
            case "e":
              e.preventDefault();
              exportReport("pdf");
              break;
          }
        }
      });

      // Interactive detail functions for stat cards
      function showInventoryDetails() {
        Notifications.info(
          "Inventory Breakdown",
          `<div style="text-align: left;">
            <h6>Current Blood Inventory:</h6>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>O+:</strong> 45 units (18%)</li>
              <li><strong>A+:</strong> 38 units (15%)</li>
              <li><strong>B+:</strong> 32 units (13%)</li>
              <li><strong>AB+:</strong> 28 units (11%)</li>
              <li><strong>O-:</strong> 42 units (17%)</li>
              <li><strong>A-:</strong> 28 units (11%)</li>
              <li><strong>B-:</strong> 22 units (9%)</li>
              <li><strong>AB-:</strong> 12 units (5%)</li>
            </ul>
            <p style="margin-top: 15px;"><em>Click on blood type requests table for more details</em></p>
          </div>`,
          null,
          true
        );
      }

      function showDonationDetails() {
        Notifications.info(
          "Donation Trends",
          `<div style="text-align: left;">
            <h6>Monthly Donation Analysis:</h6>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>This Month:</strong> 89 donations (+8%)</li>
              <li><strong>Last Month:</strong> 82 donations</li>
              <li><strong>Average per Day:</strong> 3.2 donations</li>
              <li><strong>Peak Day:</strong> Friday (avg 5.1)</li>
              <li><strong>Most Common:</strong> O+ and A+ types</li>
            </ul>
            <p style="margin-top: 15px;"><em>Trend shows consistent growth in donor participation</em></p>
          </div>`,
          null,
          true
        );
      }

      function showRequestDetails() {
        Notifications.info(
          "Blood Request Analytics",
          `<div style="text-align: left;">
            <h6>Request Summary:</h6>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Total Requests:</strong> 23 this month</li>
              <li><strong>Fulfilled:</strong> 21 (91% success rate)</li>
              <li><strong>Pending:</strong> 2 requests</li>
              <li><strong>Average Response:</strong> 2.4 hours</li>
              <li><strong>Most Requested:</strong> O- and A+ types</li>
            </ul>
            <p style="margin-top: 15px;"><em>Performance remains stable with high fulfillment rate</em></p>
          </div>`,
          null,
          true
        );
      }

      function showEmergencyDetails() {
        Notifications.info(
          "Emergency Cases Overview",
          `<div style="text-align: left;">
            <h6>Emergency Response Statistics:</h6>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Active Cases:</strong> 5 emergency requests</li>
              <li><strong>Average Response:</strong> 45 minutes</li>
              <li><strong>Success Rate:</strong> 98% (resolved within 2 hours)</li>
              <li><strong>Critical Blood Types:</strong> O-, AB-</li>
              <li><strong>Peak Hours:</strong> 2 PM - 6 PM</li>
            </ul>
            <p style="margin-top: 15px;"><em>15% decrease shows improved preventive measures</em></p>
          </div>`,
          null,
          true
        );
      }

      // Add refresh button to page header
      function addRefreshButton() {
        const pageHeader = document.querySelector(".page-header div");
        if (pageHeader && !document.querySelector(".refresh-btn")) {
          const refreshBtn = document.createElement("button");
          refreshBtn.className =
            "btn btn-outline-primary btn-sm refresh-btn pulse";
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
          refreshBtn.onclick = () => {
            refreshBtn.querySelector("i").classList.add("fa-spin");
            loadDashboardData();
            setTimeout(() => {
              refreshBtn.querySelector("i").classList.remove("fa-spin");
            }, 2000);
          };
          pageHeader.appendChild(refreshBtn);
        }
      }

      // Add real-time updates notification
      function showRealTimeStatus() {
        const statusDiv = document.createElement("div");
        statusDiv.className = "alert alert-info alert-dismissible fade show";
        statusDiv.style.cssText =
          "position: fixed; top: 80px; right: 20px; z-index: 1050; max-width: 350px;";
        statusDiv.innerHTML = `
          <i class="fas fa-broadcast-tower"></i> <strong>Live Updates Active</strong>
          <br><small>Dashboard auto-refreshes every 30 seconds</small>
          <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
          </button>
        `;
        document.body.appendChild(statusDiv);

        // Auto-hide after 5 seconds
        setTimeout(() => {
          if (statusDiv.parentNode) {
            statusDiv.classList.remove("show");
            setTimeout(() => statusDiv.remove(), 500);
          }
        }, 5000);
      }

      // Initialize additional features on page load
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          addRefreshButton();
          showRealTimeStatus();
        }, 1000);
      });

      function logout() {
        Notifications.confirm(
          "Logout",
          "Are you sure you want to logout?"
        ).then((result) => {
          if (result.isConfirmed) {
            Session.logout()
              .then(() => {
                window.location.href = "../index.html";
              })
              .catch(() => {
                window.location.href = "../index.html";
              });
          }
        });
      }
    </script>
  </body>
</html>
